<!DOCTYPE html><html lang="fa" dir="rtl"><head><meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob: https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://code.jquery.com https://unpkg.com https://d3js.org https://threejs.org https://cdn.plot.ly https://stackpath.bootstrapcdn.com https://maps.googleapis.com https://cdn.tailwindcss.com https://ajax.googleapis.com https://kit.fontawesome.com https://cdn.datatables.net https://maxcdn.bootstrapcdn.com https://code.highcharts.com https://tako-static-assets-production.s3.amazonaws.com https://www.youtube.com https://fonts.googleapis.com https://fonts.gstatic.com https://pfst.cf2.poecdn.net https://puc.poecdn.net https://i.imgur.com https://wikimedia.org https://*.icons8.com https://*.giphy.com https://picsum.photos https://images.unsplash.com; frame-src 'self' https://www.youtube.com https://trytako.com; child-src 'self'; manifest-src 'self'; worker-src 'self'; upgrade-insecure-requests; block-all-mixed-content;">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مدیر تسک‌های حرفه‌ای</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.min.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#f0f0ff',
                            100: '#e5e5ff',
                            200: '#d1d1ff',
                            300: '#b3b3ff',
                            400: '#8f8fff',
                            500: '#5D5CDE',
                            600: '#5048c7',
                            700: '#3f37a3',
                            800: '#332d82',
                            900: '#2c2769'
                        },
                        dark: {
                            bg: '#0a0a0a',
                            card: '#111111',
                            border: '#1f1f1f',
                            surface: '#171717'
                        },
                        success: '#10b981',
                        warning: '#f59e0b',
                        error: '#ef4444',
                        info: '#3b82f6'
                    },
                    fontFamily: {
                        iran: ['IRANSans', 'Tahoma', 'sans-serif']
                    },
                    animation: {
                        'slide-in': 'slideIn 0.3s ease-out',
                        'slide-out': 'slideOut 0.3s ease-in',
                        'fade-in': 'fadeIn 0.3s ease-out',
                        'bounce-in': 'bounceIn 0.5s ease-out',
                        'shake': 'shake 0.5s ease-in-out',
                        'pulse-slow': 'pulse 2s infinite'
                    },
                    keyframes: {
                        slideIn: {
                            '0%': { transform: 'translateX(100%)', opacity: '0' },
                            '100%': { transform: 'translateX(0)', opacity: '1' }
                        },
                        slideOut: {
                            '0%': { transform: 'translateX(0)', opacity: '1' },
                            '100%': { transform: 'translateX(-100%)', opacity: '0' }
                        },
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' }
                        },
                        bounceIn: {
                            '0%': { transform: 'scale(0.3)', opacity: '0' },
                            '50%': { transform: 'scale(1.05)', opacity: '1' },
                            '70%': { transform: 'scale(0.9)' },
                            '100%': { transform: 'scale(1)' }
                        },
                        shake: {
                            '0%, 100%': { transform: 'translateX(0)' },
                            '10%, 30%, 50%, 70%, 90%': { transform: 'translateX(-5px)' },
                            '20%, 40%, 60%, 80%': { transform: 'translateX(5px)' }
                        }
                    }
                }
            }
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@100..900&display=swap');
        
        * {
            font-family: 'Vazirmatn', 'Tahoma', sans-serif;
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #9ca3af;
        }
        
        .dark ::-webkit-scrollbar-thumb {
            background: #374151;
        }
        
        .dark ::-webkit-scrollbar-thumb:hover {
            background: #4b5563;
        }
        
        /* Glass Effect */
        .glass {
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
        }
        
        /* Custom Checkbox */
        .custom-checkbox {
            appearance: none;
            width: 20px;
            height: 20px;
            border: 2px solid #d1d5db;
            border-radius: 6px;
            position: relative;
            cursor: pointer;
            transition: all 0.2s ease;
            background: white;
        }
        
        .custom-checkbox:checked {
            background: #5D5CDE;
            border-color: #5D5CDE;
        }
        
        .custom-checkbox:checked::after {
            content: '✓';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 12px;
            font-weight: bold;
        }
        
        .dark .custom-checkbox {
            border-color: #4b5563;
            background: #1f2937;
        }
        
        .dark .custom-checkbox:checked {
            background: #5D5CDE;
            border-color: #5D5CDE;
        }
        
        /* Task Item Styles */
        .task-item {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .task-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        
        .dark .task-item:hover {
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }
        
        .task-completed .task-title {
            text-decoration: line-through;
            opacity: 0.6;
        }
        
        .task-completed {
            opacity: 0.7;
        }
        
        .priority-indicator {
            width: 4px;
            height: 100%;
            position: absolute;
            right: 0;
            top: 0;
            border-radius: 0 8px 8px 0;
        }
        
        .priority-high .priority-indicator { background: #ef4444; }
        .priority-medium .priority-indicator { background: #f59e0b; }
        .priority-low .priority-indicator { background: #10b981; }
        
        /* Navigation */
        .nav-item {
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }
        
        .nav-item.active {
            background: linear-gradient(135deg, #5D5CDE, #7c3aed);
            color: white;
        }
        
        .nav-item:not(.active):hover {
            background: rgba(93, 92, 222, 0.1);
        }
        
        .nav-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        
        .nav-item:hover::before {
            left: 100%;
        }
        
        /* Modal Animations */
        .modal-backdrop {
            animation: fadeIn 0.2s ease-out;
        }
        
        .modal-content {
            animation: bounceIn 0.3s ease-out;
        }
        
        /* Notification Styles */
        .notification {
            animation: slide-in 0.3s ease-out;
        }
        
        .notification.removing {
            animation: slide-out 0.3s ease-in;
        }
        
        /* Loading Spinner */
        .spinner {
            border: 2px solid #f3f4f6;
            border-top: 2px solid #5D5CDE;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Progress Bar */
        .progress-bar {
            transition: width 0.5s ease-in-out;
        }
        
        /* Tab Content */
        .tab-content {
            animation: fadeIn 0.3s ease-out;
        }
        
        /* Form Styles */
        .form-input {
            transition: all 0.2s ease;
        }
        
        .form-input:focus {
            transform: scale(1.02);
            box-shadow: 0 0 0 3px rgba(93, 92, 222, 0.1);
        }
        
        /* Drag & Drop */
        .sortable-ghost {
            opacity: 0.4;
            transform: rotate(5deg);
        }
        
        .dragging {
            z-index: 1000;
            transform: rotate(3deg) scale(1.05);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.2);
        }
        
        /* Calendar Styles */
        .calendar-day {
            transition: all 0.2s ease;
        }
        
        .calendar-day:hover {
            background: rgba(93, 92, 222, 0.1);
        }
        
        .calendar-day.today {
            background: #5D5CDE;
            color: white;
        }
        
        .calendar-day.has-tasks {
            position: relative;
        }
        
        .calendar-day.has-tasks::after {
            content: '';
            position: absolute;
            bottom: 2px;
            right: 50%;
            transform: translateX(50%);
            width: 6px;
            height: 6px;
            background: #f59e0b;
            border-radius: 50%;
        }
        
        /* Statistics Cards */
        .stat-card {
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        /* Search Highlight */
        .search-highlight {
            background: yellow;
            color: black;
            padding: 0 2px;
            border-radius: 2px;
        }
        
        /* Context Menu */
        .context-menu {
            animation: fadeIn 0.2s ease-out;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .task-item {
                margin-bottom: 12px;
            }
            
            .nav-item {
                padding: 8px 12px;
                font-size: 14px;
            }
            
            .modal-content {
                margin: 20px;
                max-height: 90vh;
                overflow-y: auto;
            }
        }
        
        /* Dark Mode Adjustments */
        .dark .glass {
            background: rgba(17, 17, 17, 0.8);
        }
        
        .dark .nav-item:not(.active):hover {
            background: rgba(93, 92, 222, 0.2);
        }
        
        .dark .context-menu {
            background: #1f2937;
            border: 1px solid #374151;
        }
        
        /* Print Styles */
        @media print {
            .no-print {
                display: none !important;
            }
            
            .task-item {
                break-inside: avoid;
                margin-bottom: 10px;
                border: 1px solid #ccc;
            }
        }
        
        /* High Contrast Mode */
        @media (prefers-contrast: high) {
            .task-item {
                border: 2px solid currentColor;
            }
            
            .custom-checkbox {
                border-width: 3px;
            }
        }
        
        /* Reduced Motion */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
    </style>
</head>

<body class="bg-gray-50 dark:bg-dark-bg min-h-screen transition-all duration-300">
    
    <!-- Loading Screen -->
    <div id="loadingScreen" class="fixed inset-0 bg-white dark:bg-dark-bg z-50 flex items-center justify-center">
        <div class="text-center">
            <div class="spinner mx-auto mb-4"></div>
            <p class="text-gray-600 dark:text-gray-400">در حال بارگذاری...</p>
        </div>
    </div>

    <!-- Header -->
    <header class="bg-white/90 dark:bg-dark-card/90 glass border-b border-gray-200 dark:border-dark-border sticky top-0 z-40 no-print">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <!-- Logo & Title -->
                <div class="flex items-center space-x-4 space-x-reverse">
                    <div class="w-10 h-10 bg-gradient-to-br from-primary-500 to-primary-600 rounded-xl flex items-center justify-center shadow-lg">
                        <i class="fas fa-tasks text-white text-lg"></i>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold text-gray-900 dark:text-white">مدیر تسک‌ها</h1>
                        <p class="text-sm text-gray-500 dark:text-gray-400 hidden sm:block">نسخه حرفه‌ای</p>
                    </div>
                </div>

                <!-- Search -->
                <div class="hidden md:flex flex-1 max-w-md mx-8">
                    <div class="relative w-full">
                        <input type="text" id="globalSearch" placeholder="جستجو در تسک‌ها..." class="w-full pl-10 pr-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-dark-surface text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                        <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                    </div>
                </div>

                <!-- Header Actions -->
                <div class="flex items-center space-x-3 space-x-reverse">
                    <!-- Notifications -->
                    <button id="notificationBtn" class="relative p-2 text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 transition-colors">
                        <i class="fas fa-bell"></i>
                        <span id="notificationBadge" class="hidden absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white text-xs rounded-full flex items-center justify-center">0</span>
                    </button>

                    <!-- Quick Add -->
                    <button id="quickAddBtn" class="p-2 text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 transition-colors">
                        <i class="fas fa-plus"></i>
                    </button>

                    <!-- Theme Toggle -->
                    <button id="themeToggle" class="p-2 text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 transition-colors">
                        <i class="fas fa-sun dark:hidden"></i>
                        <i class="fas fa-moon hidden dark:block"></i>
                    </button>

                    <!-- User Menu -->
                    <div class="relative">
                        <button id="userMenuBtn" class="flex items-center space-x-2 space-x-reverse p-2 text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 transition-colors">
                            <div class="w-8 h-8 bg-primary-500 rounded-full flex items-center justify-center">
                                <i class="fas fa-user text-white text-sm"></i>
                            </div>
                        </button>
                        
                        <!-- User Dropdown -->
                        <div id="userDropdown" class="hidden absolute left-0 mt-2 w-48 bg-white dark:bg-dark-card rounded-lg shadow-lg border border-gray-200 dark:border-dark-border z-50">
                            <div class="py-2">
                                <button class="w-full text-right px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                                    <i class="fas fa-cog ml-2"></i>تنظیمات
                                </button>
                                <button id="exportBtn" class="w-full text-right px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                                    <i class="fas fa-download ml-2"></i>خروجی گرفتن
                                </button>
                                <button id="importBtn" class="w-full text-right px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                                    <i class="fas fa-upload ml-2"></i>وارد کردن
                                </button>
                                <hr class="my-2 border-gray-200 dark:border-gray-600">
                                <button id="aboutBtn" class="w-full text-right px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                                    <i class="fas fa-info-circle ml-2"></i>درباره
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Mobile Search -->
    <div class="md:hidden bg-white dark:bg-dark-card border-b border-gray-200 dark:border-dark-border p-4 no-print">
        <div class="relative">
            <input type="text" id="mobileSearch" placeholder="جستجو..." class="w-full pl-10 pr-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-dark-surface text-gray-900 dark:text-white">
            <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
        </div>
    </div>

    <!-- Navigation -->
    <nav class="bg-white dark:bg-dark-card border-b border-gray-200 dark:border-dark-border no-print">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex space-x-1 space-x-reverse overflow-x-auto py-2">
                <button class="nav-item active px-4 py-2 rounded-lg text-sm font-medium whitespace-nowrap transition-all" data-tab="dashboard">
                    <i class="fas fa-tachometer-alt ml-2"></i>داشبورد
                </button>
                <button class="nav-item px-4 py-2 rounded-lg text-sm font-medium whitespace-nowrap transition-all text-gray-600 dark:text-gray-400" data-tab="tasks">
                    <i class="fas fa-list ml-2"></i>تسک‌ها
                </button>
                <button class="nav-item px-4 py-2 rounded-lg text-sm font-medium whitespace-nowrap transition-all text-gray-600 dark:text-gray-400" data-tab="calendar">
                    <i class="fas fa-calendar ml-2"></i>تقویم
                </button>
                <button class="nav-item px-4 py-2 rounded-lg text-sm font-medium whitespace-nowrap transition-all text-gray-600 dark:text-gray-400" data-tab="analytics">
                    <i class="fas fa-chart-bar ml-2"></i>آمار
                </button>
                <button class="nav-item px-4 py-2 rounded-lg text-sm font-medium whitespace-nowrap transition-all text-gray-600 dark:text-gray-400" data-tab="categories">
                    <i class="fas fa-tags ml-2"></i>دسته‌ها
                </button>
                <button class="nav-item px-4 py-2 rounded-lg text-sm font-medium whitespace-nowrap transition-all text-gray-600 dark:text-gray-400" data-tab="settings">
                    <i class="fas fa-cog ml-2"></i>تنظیمات
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        
        <!-- Dashboard Tab -->
        <div id="dashboardTab" class="tab-content">
            <!-- Stats Overview -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="stat-card bg-gradient-to-r from-blue-500 to-blue-600 rounded-xl p-6 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-blue-100 text-sm">کل تسک‌ها</p>
                            <p id="totalTasksCount" class="text-3xl font-bold">0</p>
                        </div>
                        <i class="fas fa-tasks text-3xl text-blue-200"></i>
                    </div>
                </div>
                
                <div class="stat-card bg-gradient-to-r from-green-500 to-green-600 rounded-xl p-6 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-green-100 text-sm">تکمیل شده</p>
                            <p id="completedTasksCount" class="text-3xl font-bold">0</p>
                        </div>
                        <i class="fas fa-check-circle text-3xl text-green-200"></i>
                    </div>
                </div>
                
                <div class="stat-card bg-gradient-to-r from-yellow-500 to-yellow-600 rounded-xl p-6 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-yellow-100 text-sm">در انتظار</p>
                            <p id="pendingTasksCount" class="text-3xl font-bold">0</p>
                        </div>
                        <i class="fas fa-clock text-3xl text-yellow-200"></i>
                    </div>
                </div>
                
                <div class="stat-card bg-gradient-to-r from-red-500 to-red-600 rounded-xl p-6 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-red-100 text-sm">عقب‌افتاده</p>
                            <p id="overdueTasksCount" class="text-3xl font-bold">0</p>
                        </div>
                        <i class="fas fa-exclamation-triangle text-3xl text-red-200"></i>
                    </div>
                </div>
            </div>

            <!-- Quick Actions & Recent Activity -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                <!-- Quick Add Task -->
                <div class="bg-white dark:bg-dark-card rounded-xl shadow-sm border border-gray-200 dark:border-dark-border p-6">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4 flex items-center">
                        <i class="fas fa-plus-circle text-primary-500 ml-2"></i>افزودن سریع
                    </h3>
                    <form id="quickTaskForm" class="space-y-4">
                        <input type="text" id="quickTaskTitle" placeholder="عنوان تسک..." class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-dark-surface text-gray-900 dark:text-white focus:ring-2 focus:ring-primary-500 focus:border-transparent form-input">
                        <div class="flex space-x-3 space-x-reverse">
                            <select id="quickTaskPriority" class="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-dark-surface text-gray-900 dark:text-white">
                                <option value="medium">متوسط</option>
                                <option value="high">بالا</option>
                                <option value="low">پایین</option>
                            </select>
                            <button type="submit" class="px-6 py-2 bg-primary-500 hover:bg-primary-600 text-white rounded-lg transition-colors">
                                افزودن
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Today's Tasks -->
                <div class="bg-white dark:bg-dark-card rounded-xl shadow-sm border border-gray-200 dark:border-dark-border p-6">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4 flex items-center">
                        <i class="fas fa-calendar-day text-primary-500 ml-2"></i>تسک‌های امروز
                    </h3>
                    <div id="todayTasksList" class="space-y-3 max-h-64 overflow-y-auto">
                        <!-- Today's tasks will be rendered here -->
                    </div>
                </div>
            </div>

            <!-- Progress Overview -->
            <div class="bg-white dark:bg-dark-card rounded-xl shadow-sm border border-gray-200 dark:border-dark-border p-6 mb-8">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">پیشرفت هفتگی</h3>
                <div class="space-y-4">
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-gray-600 dark:text-gray-400">میزان تکمیل</span>
                        <span id="completionPercentage" class="text-lg font-semibold text-primary-500">0%</span>
                    </div>
                    <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-3">
                        <div id="progressBar" class="progress-bar bg-gradient-to-r from-primary-500 to-primary-600 h-3 rounded-full" style="width: 0%"></div>
                    </div>
                    <div id="weeklyStats" class="grid grid-cols-7 gap-2 text-center">
                        <!-- Weekly stats will be rendered here -->
                    </div>
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="bg-white dark:bg-dark-card rounded-xl shadow-sm border border-gray-200 dark:border-dark-border p-6">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4 flex items-center">
                    <i class="fas fa-history text-primary-500 ml-2"></i>فعالیت اخیر
                </h3>
                <div id="recentActivity" class="space-y-3">
                    <!-- Recent activity will be rendered here -->
                </div>
            </div>
        </div>

        <!-- Tasks Tab -->
        <div id="tasksTab" class="tab-content hidden">
            <!-- Task Management Header -->
            <div class="bg-white dark:bg-dark-card rounded-xl shadow-sm border border-gray-200 dark:border-dark-border p-6 mb-6">
                <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between space-y-4 lg:space-y-0">
                    <h2 class="text-xl font-bold text-gray-900 dark:text-white">مدیریت تسک‌ها</h2>
                    
                    <!-- Filters & Actions -->
                    <div class="flex flex-wrap items-center gap-3">
                        <select id="categoryFilter" class="px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-dark-surface text-gray-900 dark:text-white text-sm">
                            <option value="all">همه دسته‌ها</option>
                            <option value="work">کاری</option>
                            <option value="personal">شخصی</option>
                            <option value="health">سلامت</option>
                            <option value="education">آموزش</option>
                            <option value="other">سایر</option>
                        </select>
                        
                        <select id="statusFilter" class="px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-dark-surface text-gray-900 dark:text-white text-sm">
                            <option value="all">همه وضعیت‌ها</option>
                            <option value="pending">در انتظار</option>
                            <option value="completed">تکمیل شده</option>
                            <option value="overdue">عقب‌افتاده</option>
                        </select>
                        
                        <select id="priorityFilter" class="px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-dark-surface text-gray-900 dark:text-white text-sm">
                            <option value="all">همه اولویت‌ها</option>
                            <option value="high">بالا</option>
                            <option value="medium">متوسط</option>
                            <option value="low">پایین</option>
                        </select>
                        
                        <select id="sortBy" class="px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-dark-surface text-gray-900 dark:text-white text-sm">
                            <option value="created">تاریخ ایجاد</option>
                            <option value="priority">اولویت</option>
                            <option value="dueDate">موعد انجام</option>
                            <option value="title">عنوان</option>
                        </select>
                        
                        <button id="addTaskBtn" class="px-4 py-2 bg-primary-500 hover:bg-primary-600 text-white rounded-lg transition-colors text-sm">
                            <i class="fas fa-plus ml-1"></i>تسک جدید
                        </button>
                    </div>
                </div>
            </div>

            <!-- Bulk Actions -->
            <div id="bulkActions" class="hidden bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4 mb-6">
                <div class="flex items-center justify-between">
                    <span class="text-blue-700 dark:text-blue-300" id="selectedCount">0 تسک انتخاب شده</span>
                    <div class="flex space-x-2 space-x-reverse">
                        <button id="bulkCompleteBtn" class="px-3 py-1 bg-green-500 text-white rounded text-sm hover:bg-green-600 transition-colors">
                            تکمیل همه
                        </button>
                        <button id="bulkDeleteBtn" class="px-3 py-1 bg-red-500 text-white rounded text-sm hover:bg-red-600 transition-colors">
                            حذف همه
                        </button>
                        <button id="clearSelectionBtn" class="px-3 py-1 bg-gray-500 text-white rounded text-sm hover:bg-gray-600 transition-colors">
                            لغو انتخاب
                        </button>
                    </div>
                </div>
            </div>

            <!-- Tasks List -->
            <div id="tasksList" class="space-y-4">
                <!-- Tasks will be rendered here -->
            </div>

            <!-- Load More -->
            <div id="loadMoreContainer" class="hidden text-center mt-8">
                <button id="loadMoreBtn" class="px-6 py-3 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">
                    نمایش بیشتر
                </button>
            </div>

            <!-- Empty State -->
            <div id="tasksEmptyState" class="hidden text-center py-16">
                <div class="w-24 h-24 bg-gray-100 dark:bg-gray-800 rounded-full flex items-center justify-center mx-auto mb-6">
                    <i class="fas fa-tasks text-4xl text-gray-400"></i>
                </div>
                <h3 class="text-xl font-semibold text-gray-900 dark:text-white mb-2">هیچ تسکی یافت نشد</h3>
                <p class="text-gray-500 dark:text-gray-400 mb-6">اولین تسک خود را ایجاد کنید یا فیلترها را تغییر دهید</p>
                <button class="px-6 py-3 bg-primary-500 hover:bg-primary-600 text-white rounded-lg transition-colors" onclick="showTaskModal()">
                    <i class="fas fa-plus ml-2"></i>تسک جدید
                </button>
            </div>
        </div>

        <!-- Calendar Tab -->
        <div id="calendarTab" class="tab-content hidden">
            <div class="bg-white dark:bg-dark-card rounded-xl shadow-sm border border-gray-200 dark:border-dark-border p-6">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-xl font-bold text-gray-900 dark:text-white">تقویم تسک‌ها</h2>
                    <div class="flex items-center space-x-3 space-x-reverse">
                        <button id="prevMonth" class="p-2 text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                        <span id="currentMonth" class="text-lg font-semibold text-gray-900 dark:text-white"></span>
                        <button id="nextMonth" class="p-2 text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                    </div>
                </div>
                
                <div id="calendar" class="grid grid-cols-7 gap-2">
                    <!-- Calendar will be rendered here -->
                </div>
                
                <div id="calendarTasksList" class="mt-8">
                    <!-- Selected day tasks will be shown here -->
                </div>
            </div>
        </div>

        <!-- Analytics Tab -->
        <div id="analyticsTab" class="tab-content hidden">
            <div class="space-y-8">
                <!-- Charts Row -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Task Completion Chart -->
                    <div class="bg-white dark:bg-dark-card rounded-xl shadow-sm border border-gray-200 dark:border-dark-border p-6">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">روند تکمیل تسک‌ها</h3>
                        <canvas id="completionChart" width="400" height="200"></canvas>
                    </div>
                    
                    <!-- Priority Distribution -->
                    <div class="bg-white dark:bg-dark-card rounded-xl shadow-sm border border-gray-200 dark:border-dark-border p-6">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">توزیع اولویت</h3>
                        <canvas id="priorityChart" width="400" height="200"></canvas>
                    </div>
                </div>

                <!-- Category Stats -->
                <div class="bg-white dark:bg-dark-card rounded-xl shadow-sm border border-gray-200 dark:border-dark-border p-6">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">آمار دسته‌بندی</h3>
                    <div id="categoryStats" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <!-- Category stats will be rendered here -->
                    </div>
                </div>

                <!-- Time Analysis -->
                <div class="bg-white dark:bg-dark-card rounded-xl shadow-sm border border-gray-200 dark:border-dark-border p-6">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">تحلیل زمانی</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="text-center">
                            <div class="text-3xl font-bold text-primary-500" id="avgCompletionTime">0</div>
                            <div class="text-sm text-gray-500 dark:text-gray-400">میانگین زمان تکمیل (روز)</div>
                        </div>
                        <div class="text-center">
                            <div class="text-3xl font-bold text-green-500" id="onTimeCompletion">0%</div>
                            <div class="text-sm text-gray-500 dark:text-gray-400">تکمیل به موقع</div>
                        </div>
                        <div class="text-center">
                            <div class="text-3xl font-bold text-blue-500" id="productivityScore">0</div>
                            <div class="text-sm text-gray-500 dark:text-gray-400">امتیاز بهره‌وری</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Categories Tab -->
        <div id="categoriesTab" class="tab-content hidden">
            <div class="bg-white dark:bg-dark-card rounded-xl shadow-sm border border-gray-200 dark:border-dark-border p-6">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-xl font-bold text-gray-900 dark:text-white">مدیریت دسته‌ها</h2>
                    <button id="addCategoryBtn" class="px-4 py-2 bg-primary-500 hover:bg-primary-600 text-white rounded-lg transition-colors">
                        <i class="fas fa-plus ml-2"></i>دسته جدید
                    </button>
                </div>
                
                <div id="categoriesList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- Categories will be rendered here -->
                </div>
            </div>
        </div>

        <!-- Settings Tab -->
        <div id="settingsTab" class="tab-content hidden">
            <div class="space-y-6">
                <!-- General Settings -->
                <div class="bg-white dark:bg-dark-card rounded-xl shadow-sm border border-gray-200 dark:border-dark-border p-6">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">تنظیمات عمومی</h3>
                    <div class="space-y-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <label class="text-gray-700 dark:text-gray-300 font-medium">حالت تاریک خودکار</label>
                                <p class="text-sm text-gray-500 dark:text-gray-400">تنظیم خودکار بر اساس سیستم</p>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="autoTheme" class="sr-only peer">
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-primary-300 dark:peer-focus:ring-primary-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-primary-500"></div>
                            </label>
                        </div>
                        
                        <div class="flex items-center justify-between">
                            <div>
                                <label class="text-gray-700 dark:text-gray-300 font-medium">نوتیفیکیشن‌ها</label>
                                <p class="text-sm text-gray-500 dark:text-gray-400">دریافت یادآوری برای تسک‌ها</p>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="enableNotifications" class="sr-only peer">
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-primary-300 dark:peer-focus:ring-primary-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-primary-500"></div>
                            </label>
                        </div>
                        
                        <div class="flex items-center justify-between">
                            <div>
                                <label class="text-gray-700 dark:text-gray-300 font-medium">صدای نوتیفیکیشن</label>
                                <p class="text-sm text-gray-500 dark:text-gray-400">پخش صدا هنگام دریافت یادآوری</p>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="notificationSound" class="sr-only peer">
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-primary-300 dark:peer-focus:ring-primary-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-primary-500"></div>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Data Management -->
                <div class="bg-white dark:bg-dark-card rounded-xl shadow-sm border border-gray-200 dark:border-dark-border p-6">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">مدیریت داده‌ها</h3>
                    <div class="space-y-4">
                        <button id="backupBtn" class="w-full flex items-center justify-center px-4 py-3 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-colors">
                            <i class="fas fa-download ml-2"></i>پشتیبان‌گیری از داده‌ها
                        </button>
                        
                        <div class="relative">
                            <input type="file" id="restoreInput" accept=".json" class="hidden">
                            <button onclick="document.getElementById('restoreInput').click()" class="w-full flex items-center justify-center px-4 py-3 bg-green-500 hover:bg-green-600 text-white rounded-lg transition-colors">
                                <i class="fas fa-upload ml-2"></i>بازیابی از پشتیبان
                            </button>
                        </div>
                        
                        <button id="clearDataBtn" class="w-full flex items-center justify-center px-4 py-3 bg-red-500 hover:bg-red-600 text-white rounded-lg transition-colors">
                            <i class="fas fa-trash ml-2"></i>پاک کردن تمام داده‌ها
                        </button>
                    </div>
                </div>

                <!-- About -->
                <div class="bg-white dark:bg-dark-card rounded-xl shadow-sm border border-gray-200 dark:border-dark-border p-6">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">درباره برنامه</h3>
                    <div class="space-y-2 text-sm text-gray-600 dark:text-gray-400">
                        <p><strong>نام:</strong> مدیر تسک‌های حرفه‌ای</p>
                        <p><strong>نسخه:</strong> 2.0.0</p>
                        <p><strong>سازنده:</strong> تیم توسعه</p>
                        <p><strong>آخرین به‌روزرسانی:</strong> <span id="lastUpdateDate"></span></p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Task Modal -->
    <div id="taskModal" class="fixed inset-0 bg-black/50 glass flex items-center justify-center z-50 hidden modal-backdrop">
        <div class="bg-white dark:bg-dark-card rounded-xl shadow-2xl max-w-2xl w-full mx-4 max-h-90vh overflow-y-auto modal-content">
            <div class="p-6">
                <div class="flex items-center justify-between mb-6">
                    <h3 id="modalTitle" class="text-xl font-bold text-gray-900 dark:text-white">تسک جدید</h3>
                    <button id="closeModal" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <form id="taskModalForm" class="space-y-6">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="lg:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">عنوان تسک</label>
                            <input type="text" id="modalTaskTitle" placeholder="عنوان تسک را وارد کنید..." class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-dark-surface text-gray-900 dark:text-white focus:ring-2 focus:ring-primary-500 focus:border-transparent form-input" required="">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">دسته‌بندی</label>
                            <select id="modalTaskCategory" class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-dark-surface text-gray-900 dark:text-white focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                                <option value="work">کاری</option>
                                <option value="personal">شخصی</option>
                                <option value="health">سلامت</option>
                                <option value="education">آموزش</option>
                                <option value="other">سایر</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">اولویت</label>
                            <select id="modalTaskPriority" class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-dark-surface text-gray-900 dark:text-white focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                                <option value="low">پایین</option>
                                <option value="medium" selected="">متوسط</option>
                                <option value="high">بالا</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">موعد انجام</label>
                            <input type="datetime-local" id="modalTaskDueDate" class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-dark-surface text-gray-900 dark:text-white focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">یادآوری</label>
                            <input type="datetime-local" id="modalTaskReminder" class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-dark-surface text-gray-900 dark:text-white focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                        </div>
                        
                        <div class="lg:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">توضیحات</label>
                            <textarea id="modalTaskDescription" placeholder="توضیحات اضافی..." rows="4" class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-dark-surface text-gray-900 dark:text-white focus:ring-2 focus:ring-primary-500 focus:border-transparent resize-none"></textarea>
                        </div>
                        
                        <div class="lg:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">تکرار</label>
                            <select id="modalTaskRepeat" class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-dark-surface text-gray-900 dark:text-white focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                                <option value="none">بدون تکرار</option>
                                <option value="daily">روزانه</option>
                                <option value="weekly">هفتگی</option>
                                <option value="monthly">ماهانه</option>
                            </select>
                        </div>
                        
                        <div class="lg:col-span-2">
                            <div class="flex items-center space-x-3 space-x-reverse">
                                <input type="checkbox" id="modalTaskImportant" class="custom-checkbox">
                                <label for="modalTaskImportant" class="text-sm text-gray-700 dark:text-gray-300">تسک مهم</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex justify-end space-x-3 space-x-reverse pt-6 border-t border-gray-200 dark:border-gray-600">
                        <button type="button" id="cancelModalBtn" class="px-6 py-3 text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-gray-700 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">
                            لغو
                        </button>
                        <button type="submit" id="saveTaskBtn" class="px-6 py-3 bg-primary-500 hover:bg-primary-600 text-white rounded-lg transition-colors">
                            <i class="fas fa-save ml-2"></i>ذخیره
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Notification Panel -->
    <div id="notificationPanel" class="fixed top-16 left-4 w-80 bg-white dark:bg-dark-card rounded-xl shadow-2xl border border-gray-200 dark:border-dark-border z-40 hidden">
        <div class="p-4 border-b border-gray-200 dark:border-gray-600">
            <h3 class="font-semibold text-gray-900 dark:text-white">اعلان‌ها</h3>
        </div>
        <div id="notificationList" class="max-h-96 overflow-y-auto">
            <!-- Notifications will be rendered here -->
        </div>
        <div class="p-4 border-t border-gray-200 dark:border-gray-600">
            <button id="clearNotifications" class="w-full text-center text-sm text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200">
                پاک کردن همه
            </button>
        </div>
    </div>

    <!-- Context Menu -->
    <div id="contextMenu" class="fixed bg-white dark:bg-dark-card rounded-lg shadow-lg border border-gray-200 dark:border-dark-border z-50 hidden context-menu">
        <div class="py-2">
            <button class="context-menu-item w-full text-right px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700" data-action="edit">
                <i class="fas fa-edit ml-2"></i>ویرایش
            </button>
            <button class="context-menu-item w-full text-right px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700" data-action="duplicate">
                <i class="fas fa-copy ml-2"></i>کپی
            </button>
            <button class="context-menu-item w-full text-right px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700" data-action="complete">
                <i class="fas fa-check ml-2"></i>تکمیل
            </button>
            <hr class="my-2 border-gray-200 dark:border-gray-600">
            <button class="context-menu-item w-full text-right px-4 py-2 text-sm text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20" data-action="delete">
                <i class="fas fa-trash ml-2"></i>حذف
            </button>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div id="toastContainer" class="fixed bottom-4 left-4 space-y-3 z-50">
        <!-- Toast notifications will be rendered here -->
    </div>

    <!-- Confirm Dialog -->
    <div id="confirmDialog" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="bg-white dark:bg-dark-card rounded-xl p-6 max-w-md mx-4 shadow-2xl">
            <div class="text-center">
                <div class="w-16 h-16 bg-yellow-100 dark:bg-yellow-900/20 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-exclamation-triangle text-yellow-600 dark:text-yellow-400 text-2xl"></i>
                </div>
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-2" id="confirmTitle">تأیید عملیات</h3>
                <p class="text-gray-600 dark:text-gray-400 mb-6" id="confirmMessage">آیا مطمئن هستید؟</p>
                <div class="flex space-x-3 space-x-reverse">
                    <button id="confirmCancel" class="flex-1 px-4 py-2 text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-gray-700 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">
                        لغو
                    </button>
                    <button id="confirmOk" class="flex-1 px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors">
                        تأیید
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-black/20 flex items-center justify-center z-50 hidden">
        <div class="bg-white dark:bg-dark-card rounded-xl p-6 shadow-2xl">
            <div class="flex items-center space-x-3 space-x-reverse">
                <div class="spinner"></div>
                <span class="text-gray-700 dark:text-gray-300">در حال پردازش...</span>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        // ================================
        // Application State Management
        // ================================
        
        class TaskManager {
            constructor() {
                this.tasks = [];
                this.categories = [
                    { id: 'work', name: 'کاری', icon: 'fas fa-briefcase', color: '#3b82f6' },
                    { id: 'personal', name: 'شخصی', icon: 'fas fa-user', color: '#10b981' },
                    { id: 'health', name: 'سلامت', icon: 'fas fa-heart', color: '#ef4444' },
                    { id: 'education', name: 'آموزش', icon: 'fas fa-graduation-cap', color: '#8b5cf6' },
                    { id: 'other', name: 'سایر', icon: 'fas fa-folder', color: '#6b7280' }
                ];
                this.settings = {
                    theme: 'light',
                    autoTheme: true,
                    notifications: false,
                    notificationSound: true,
                    language: 'fa'
                };
                this.notifications = [];
                this.currentEditingTask = null;
                this.selectedTasks = new Set();
                this.filters = {
                    category: 'all',
                    status: 'all',
                    priority: 'all'
                };
                this.sortBy = 'created';
                this.currentView = 'dashboard';
                this.searchQuery = '';
                this.currentPage = 1;
                this.tasksPerPage = 20;
                this.charts = {};
                
                this.init();
            }

            // ================================
            // Initialization
            // ================================
            
            init() {
                this.loadData();
                this.setupEventListeners();
                this.setupTheme();
                this.setupNotifications();
                this.render();
                this.hideLoadingScreen();
                this.setupKeyboardShortcuts();
                this.setupAutoSave();
                this.checkOverdueTasks();
            }

            hideLoadingScreen() {
                setTimeout(() => {
                    document.getElementById('loadingScreen').style.display = 'none';
                }, 1000);
            }

            // ================================
            // Data Management
            // ================================
            
            loadData() {
                try {
                    const savedTasks = localStorage.getItem('taskManager_tasks');
                    const savedSettings = localStorage.getItem('taskManager_settings');
                    const savedNotifications = localStorage.getItem('taskManager_notifications');
                    
                    if (savedTasks) {
                        this.tasks = JSON.parse(savedTasks);
                    }
                    
                    if (savedSettings) {
                        this.settings = { ...this.settings, ...JSON.parse(savedSettings) };
                    }
                    
                    if (savedNotifications) {
                        this.notifications = JSON.parse(savedNotifications);
                    }
                    
                    // Validate and clean data
                    this.validateTasks();
                } catch (error) {
                    console.error('Error loading data:', error);
                    this.showToast('خطا در بارگذاری داده‌ها', 'error');
                }
            }

            saveData() {
                try {
                    localStorage.setItem('taskManager_tasks', JSON.stringify(this.tasks));
                    localStorage.setItem('taskManager_settings', JSON.stringify(this.settings));
                    localStorage.setItem('taskManager_notifications', JSON.stringify(this.notifications));
                } catch (error) {
                    console.error('Error saving data:', error);
                    this.showToast('خطا در ذخیره داده‌ها', 'error');
                }
            }

            validateTasks() {
                this.tasks = this.tasks.filter(task => task && task.id && task.title);
                this.tasks.forEach(task => {
                    if (!task.createdAt) task.createdAt = new Date().toISOString();
                    if (!task.updatedAt) task.updatedAt = task.createdAt;
                    if (!task.category) task.category = 'other';
                    if (!task.priority) task.priority = 'medium';
                    if (task.completed === undefined) task.completed = false;
                });
            }

            setupAutoSave() {
                // Auto-save every 30 seconds
                setInterval(() => {
                    this.saveData();
                }, 30000);
            }

            // ================================
            // Task Operations
            // ================================
            
            generateId() {
                return Date.now().toString(36) + Math.random().toString(36).substr(2);
            }

            addTask(taskData) {
                const task = {
                    id: this.generateId(),
                    title: taskData.title.trim(),
                    description: taskData.description?.trim() || '',
                    category: taskData.category || 'other',
                    priority: taskData.priority || 'medium',
                    dueDate: taskData.dueDate || null,
                    reminder: taskData.reminder || null,
                    repeat: taskData.repeat || 'none',
                    completed: false,
                    important: taskData.important || false,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString(),
                    completedAt: null
                };

                this.tasks.unshift(task);
                this.saveData();
                this.addNotification('تسک جدید ایجاد شد', `"${task.title}" به لیست تسک‌ها اضافه شد`);
                this.showToast('تسک جدید اضافه شد', 'success');
                
                if (task.reminder) {
                    this.scheduleReminder(task);
                }
                
                this.render();
                return task;
            }

            updateTask(taskId, updates) {
                const taskIndex = this.tasks.findIndex(task => task.id === taskId);
                if (taskIndex === -1) return null;

                const oldTask = { ...this.tasks[taskIndex] };
                this.tasks[taskIndex] = {
                    ...this.tasks[taskIndex],
                    ...updates,
                    updatedAt: new Date().toISOString()
                };

                if (updates.completed !== undefined && updates.completed !== oldTask.completed) {
                    this.tasks[taskIndex].completedAt = updates.completed ? new Date().toISOString() : null;
                    
                    if (updates.completed) {
                        this.addNotification('تسک تکمیل شد', `"${this.tasks[taskIndex].title}" تکمیل شد`);
                        this.showToast('تسک تکمیل شد! 🎉', 'success');
                        
                        // Handle repeating tasks
                        if (this.tasks[taskIndex].repeat !== 'none') {
                            this.createRepeatingTask(this.tasks[taskIndex]);
                        }
                    }
                }

                this.saveData();
                this.render();
                return this.tasks[taskIndex];
            }

            deleteTask(taskId) {
                const taskIndex = this.tasks.findIndex(task => task.id === taskId);
                if (taskIndex === -1) return false;

                const task = this.tasks[taskIndex];
                this.tasks.splice(taskIndex, 1);
                this.selectedTasks.delete(taskId);
                
                this.saveData();
                this.addNotification('تسک حذف شد', `"${task.title}" حذف شد`);
                this.showToast('تسک حذف شد', 'info');
                this.render();
                return true;
            }

            duplicateTask(taskId) {
                const task = this.tasks.find(t => t.id === taskId);
                if (!task) return null;

                const duplicatedTask = {
                    ...task,
                    id: this.generateId(),
                    title: `${task.title} (کپی)`,
                    completed: false,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString(),
                    completedAt: null
                };

                this.tasks.unshift(duplicatedTask);
                this.saveData();
                this.showToast('تسک کپی شد', 'success');
                this.render();
                return duplicatedTask;
            }

            createRepeatingTask(task) {
                const nextDueDate = this.calculateNextDueDate(task.dueDate, task.repeat);
                if (!nextDueDate) return null;

                const repeatingTask = {
                    ...task,
                    id: this.generateId(),
                    completed: false,
                    dueDate: nextDueDate,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString(),
                    completedAt: null
                };

                this.tasks.unshift(repeatingTask);
                this.saveData();
                this.showToast('تسک تکرارشونده ایجاد شد', 'info');
                return repeatingTask;
            }

            calculateNextDueDate(dueDate, repeat) {
                if (!dueDate || repeat === 'none') return null;
                
                const date = new Date(dueDate);
                
                switch (repeat) {
                    case 'daily':
                        date.setDate(date.getDate() + 1);
                        break;
                    case 'weekly':
                        date.setDate(date.getDate() + 7);
                        break;
                    case 'monthly':
                        date.setMonth(date.getMonth() + 1);
                        break;
                    default:
                        return null;
                }
                
                return date.toISOString().slice(0, 16);
            }

            // ================================
            // Task Filtering & Sorting
            // ================================
            
            getFilteredTasks() {
                let filtered = this.tasks;

                // Search filter
                if (this.searchQuery) {
                    const query = this.searchQuery.toLowerCase();
                    filtered = filtered.filter(task =>
                        task.title.toLowerCase().includes(query) ||
                        task.description.toLowerCase().includes(query)
                    );
                }

                // Category filter
                if (this.filters.category !== 'all') {
                    filtered = filtered.filter(task => task.category === this.filters.category);
                }

                // Status filter
                if (this.filters.status === 'completed') {
                    filtered = filtered.filter(task => task.completed);
                } else if (this.filters.status === 'pending') {
                    filtered = filtered.filter(task => !task.completed);
                } else if (this.filters.status === 'overdue') {
                    filtered = filtered.filter(task => 
                        !task.completed && task.dueDate && new Date(task.dueDate) < new Date()
                    );
                }

                // Priority filter
                if (this.filters.priority !== 'all') {
                    filtered = filtered.filter(task => task.priority === this.filters.priority);
                }

                return filtered;
            }

            getSortedTasks(tasks) {
                return [...tasks].sort((a, b) => {
                    switch (this.sortBy) {
                        case 'priority':
                            const priorityOrder = { high: 3, medium: 2, low: 1 };
                            return priorityOrder[b.priority] - priorityOrder[a.priority];
                        case 'dueDate':
                            if (!a.dueDate && !b.dueDate) return 0;
                            if (!a.dueDate) return 1;
                            if (!b.dueDate) return -1;
                            return new Date(a.dueDate) - new Date(b.dueDate);
                        case 'title':
                            return a.title.localeCompare(b.title, 'fa');
                        case 'created':
                        default:
                            return new Date(b.createdAt) - new Date(a.createdAt);
                    }
                });
            }

            getPaginatedTasks(tasks) {
                const startIndex = (this.currentPage - 1) * this.tasksPerPage;
                const endIndex = startIndex + this.tasksPerPage;
                return tasks.slice(startIndex, endIndex);
            }

            // ================================
            // Bulk Operations
            // ================================
            
            selectTask(taskId, selected = true) {
                if (selected) {
                    this.selectedTasks.add(taskId);
                } else {
                    this.selectedTasks.delete(taskId);
                }
                this.updateBulkActions();
            }

            selectAllTasks(tasks, selected = true) {
                if (selected) {
                    tasks.forEach(task => this.selectedTasks.add(task.id));
                } else {
                    this.selectedTasks.clear();
                }
                this.updateBulkActions();
                this.renderTasks();
            }

            bulkCompleteTask() {
                let count = 0;
                this.selectedTasks.forEach(taskId => {
                    const task = this.tasks.find(t => t.id === taskId);
                    if (task && !task.completed) {
                        this.updateTask(taskId, { completed: true });
                        count++;
                    }
                });
                
                this.selectedTasks.clear();
                this.showToast(`${count} تسک تکمیل شد`, 'success');
                this.updateBulkActions();
            }

            bulkDeleteTasks() {
                const count = this.selectedTasks.size;
                this.selectedTasks.forEach(taskId => {
                    this.deleteTask(taskId);
                });
                
                this.selectedTasks.clear();
                this.showToast(`${count} تسک حذف شد`, 'info');
                this.updateBulkActions();
            }

            updateBulkActions() {
                const bulkActions = document.getElementById('bulkActions');
                const selectedCount = document.getElementById('selectedCount');
                
                if (this.selectedTasks.size > 0) {
                    bulkActions.classList.remove('hidden');
                    selectedCount.textContent = `${this.selectedTasks.size} تسک انتخاب شده`;
                } else {
                    bulkActions.classList.add('hidden');
                }
            }

            // ================================
            // Theme Management
            // ================================
            
            setupTheme() {
                // Check for saved theme or default to system preference
                const savedTheme = this.settings.theme;
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                
                if (savedTheme === 'dark' || (this.settings.autoTheme && prefersDark)) {
                    document.documentElement.classList.add('dark');
                    this.settings.theme = 'dark';
                } else {
                    document.documentElement.classList.remove('dark');
                    this.settings.theme = 'light';
                }

                // Listen for system theme changes
                window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
                    if (this.settings.autoTheme) {
                        if (e.matches) {
                            document.documentElement.classList.add('dark');
                            this.settings.theme = 'dark';
                        } else {
                            document.documentElement.classList.remove('dark');
                            this.settings.theme = 'light';
                        }
                        this.saveData();
                    }
                });
            }

            toggleTheme() {
                document.documentElement.classList.toggle('dark');
                this.settings.theme = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
                this.settings.autoTheme = false;
                this.saveData();
                this.showToast(`حالت ${this.settings.theme === 'dark' ? 'تاریک' : 'روشن'} فعال شد`, 'info');
            }

            // ================================
            // Notifications
            // ================================
            
            setupNotifications() {
                if ('Notification' in window && this.settings.notifications) {
                    Notification.requestPermission();
                }

                // Set up existing reminders
                this.tasks.forEach(task => {
                    if (task.reminder && !task.completed) {
                        this.scheduleReminder(task);
                    }
                });
            }

            addNotification(title, message, type = 'info') {
                const notification = {
                    id: this.generateId(),
                    title,
                    message,
                    type,
                    timestamp: new Date().toISOString(),
                    read: false
                };

                this.notifications.unshift(notification);
                this.updateNotificationBadge();
                this.saveData();
            }

            markNotificationAsRead(id) {
                const notification = this.notifications.find(n => n.id === id);
                if (notification) {
                    notification.read = true;
                    this.updateNotificationBadge();
                    this.saveData();
                }
            }

            clearNotifications() {
                this.notifications = [];
                this.updateNotificationBadge();
                this.saveData();
                this.renderNotifications();
            }

            updateNotificationBadge() {
                const badge = document.getElementById('notificationBadge');
                const unreadCount = this.notifications.filter(n => !n.read).length;
                
                if (unreadCount > 0) {
                    badge.classList.remove('hidden');
                    badge.textContent = unreadCount > 99 ? '99+' : unreadCount;
                } else {
                    badge.classList.add('hidden');
                }
            }

            scheduleReminder(task) {
                if (!task.reminder) return;

                const reminderTime = new Date(task.reminder);
                const now = new Date();
                const timeUntilReminder = reminderTime.getTime() - now.getTime();

                if (timeUntilReminder > 0) {
                    setTimeout(() => {
                        if (!task.completed) {
                            this.showReminder(task);
                        }
                    }, timeUntilReminder);
                }
            }

            showReminder(task) {
                // Browser notification
                if ('Notification' in window && Notification.permission === 'granted' && this.settings.notifications) {
                    new Notification('یادآوری تسک', {
                        body: task.title,
                        icon: '/favicon.ico',
                        tag: task.id
                    });
                }

                // Sound notification
                if (this.settings.notificationSound) {
                    this.playNotificationSound();
                }

                // In-app notification
                this.addNotification('یادآوری', `زمان انجام "${task.title}" فرا رسیده است`, 'warning');
                this.showToast(`یادآوری: ${task.title}`, 'warning');
            }

            playNotificationSound() {
                const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBziR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSl+zO/E');
                audio.volume = 0.3;
                audio.play().catch(() => {});
            }

            checkOverdueTasks() {
                const now = new Date();
                const overdueTasks = this.tasks.filter(task => 
                    !task.completed && task.dueDate && new Date(task.dueDate) < now
                );

                if (overdueTasks.length > 0) {
                    this.addNotification(
                        'تسک‌های عقب‌افتاده', 
                        `${overdueTasks.length} تسک عقب‌افتاده دارید`, 
                        'warning'
                    );
                }

                // Check again in 1 hour
                setTimeout(() => this.checkOverdueTasks(), 3600000);
            }

            // ================================
            // UI Management
            // ================================
            
            showToast(message, type = 'info', duration = 3000) {
                const toast = document.createElement('div');
                const colors = {
                    success: 'bg-green-500 text-white',
                    error: 'bg-red-500 text-white',
                    warning: 'bg-yellow-500 text-white',
                    info: 'bg-blue-500 text-white'
                };

                const icons = {
                    success: 'fa-check-circle',
                    error: 'fa-exclamation-circle',
                    warning: 'fa-exclamation-triangle',
                    info: 'fa-info-circle'
                };

                toast.className = `${colors[type]} px-4 py-3 rounded-lg shadow-lg flex items-center space-x-3 space-x-reverse notification`;
                toast.innerHTML = `
                    <i class="fas ${icons[type]}"></i>
                    <span>${message}</span>
                `;

                const container = document.getElementById('toastContainer');
                container.appendChild(toast);

                setTimeout(() => {
                    toast.classList.add('removing');
                    setTimeout(() => toast.remove(), 300);
                }, duration);
            }

            showConfirm(title, message) {
                return new Promise((resolve) => {
                    const modal = document.getElementById('confirmDialog');
                    const titleEl = document.getElementById('confirmTitle');
                    const messageEl = document.getElementById('confirmMessage');
                    const okBtn = document.getElementById('confirmOk');
                    const cancelBtn = document.getElementById('confirmCancel');

                    titleEl.textContent = title;
                    messageEl.textContent = message;
                    modal.classList.remove('hidden');

                    function handleConfirm() {
                        modal.classList.add('hidden');
                        okBtn.removeEventListener('click', handleConfirm);
                        cancelBtn.removeEventListener('click', handleCancel);
                        resolve(true);
                    }

                    function handleCancel() {
                        modal.classList.add('hidden');
                        okBtn.removeEventListener('click', handleConfirm);
                        cancelBtn.removeEventListener('click', handleCancel);
                        resolve(false);
                    }

                    okBtn.addEventListener('click', handleConfirm);
                    cancelBtn.addEventListener('click', handleCancel);
                });
            }

            showLoading(show = true) {
                const overlay = document.getElementById('loadingOverlay');
                if (show) {
                    overlay.classList.remove('hidden');
                } else {
                    overlay.classList.add('hidden');
                }
            }

            // ================================
            // Event Listeners
            // ================================
            
            setupEventListeners() {
                // Navigation
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.addEventListener('click', (e) => {
                        const tab = e.currentTarget.dataset.tab;
                        this.switchTab(tab);
                    });
                });

                // Theme toggle
                document.getElementById('themeToggle').addEventListener('click', () => {
                    this.toggleTheme();
                });

                // Search
                const searchInputs = ['globalSearch', 'mobileSearch'];
                searchInputs.forEach(id => {
                    const input = document.getElementById(id);
                    if (input) {
                        input.addEventListener('input', (e) => {
                            this.searchQuery = e.target.value;
                            this.currentPage = 1;
                            this.renderTasks();
                        });
                    }
                });

                // Quick task form
                document.getElementById('quickTaskForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    const title = document.getElementById('quickTaskTitle').value.trim();
                    const priority = document.getElementById('quickTaskPriority').value;
                    
                    if (title) {
                        this.addTask({ title, priority });
                        document.getElementById('quickTaskForm').reset();
                    }
                });

                // Task modal
                document.getElementById('addTaskBtn').addEventListener('click', () => this.showTaskModal());
                document.getElementById('quickAddBtn').addEventListener('click', () => this.showTaskModal());
                document.getElementById('closeModal').addEventListener('click', () => this.hideTaskModal());
                document.getElementById('cancelModalBtn').addEventListener('click', () => this.hideTaskModal());
                document.getElementById('taskModalForm').addEventListener('submit', (e) => this.handleTaskSubmit(e));

                // Filters
                ['categoryFilter', 'statusFilter', 'priorityFilter'].forEach(id => {
                    document.getElementById(id).addEventListener('change', (e) => {
                        const filterName = id.replace('Filter', '');
                        this.filters[filterName] = e.target.value;
                        this.currentPage = 1;
                        this.renderTasks();
                    });
                });

                // Sort
                document.getElementById('sortBy').addEventListener('change', (e) => {
                    this.sortBy = e.target.value;
                    this.renderTasks();
                });

                // Bulk actions
                document.getElementById('bulkCompleteBtn').addEventListener('click', () => {
                    this.bulkCompleteTask();
                });

                document.getElementById('bulkDeleteBtn').addEventListener('click', async () => {
                    const confirmed = await this.showConfirm('حذف گروهی', `آیا می‌خواهید ${this.selectedTasks.size} تسک انتخاب‌شده را حذف کنید؟`);
                    if (confirmed) {
                        this.bulkDeleteTasks();
                    }
                });

                document.getElementById('clearSelectionBtn').addEventListener('click', () => {
                    this.selectAllTasks([], false);
                });

                // Load more
                document.getElementById('loadMoreBtn').addEventListener('click', () => {
                    this.currentPage++;
                    this.renderTasks();
                });

                // Notification panel
                document.getElementById('notificationBtn').addEventListener('click', () => {
                    this.toggleNotificationPanel();
                });

                document.getElementById('clearNotifications').addEventListener('click', () => {
                    this.clearNotifications();
                });

                // User menu
                document.getElementById('userMenuBtn').addEventListener('click', () => {
                    this.toggleUserMenu();
                });

                // Settings
                document.getElementById('autoTheme').addEventListener('change', (e) => {
                    this.settings.autoTheme = e.target.checked;
                    this.saveData();
                });

                document.getElementById('enableNotifications').addEventListener('change', async (e) => {
                    if (e.target.checked) {
                        const permission = await Notification.requestPermission();
                        this.settings.notifications = permission === 'granted';
                        e.target.checked = this.settings.notifications;
                    } else {
                        this.settings.notifications = false;
                    }
                    this.saveData();
                });

                document.getElementById('notificationSound').addEventListener('change', (e) => {
                    this.settings.notificationSound = e.target.checked;
                    this.saveData();
                });

                // Data management
                document.getElementById('backupBtn').addEventListener('click', () => this.exportData());
                document.getElementById('restoreInput').addEventListener('change', (e) => this.importData(e));
                document.getElementById('clearDataBtn').addEventListener('click', async () => {
                    const confirmed = await this.showConfirm('پاک کردن داده‌ها', 'آیا می‌خواهید تمام داده‌ها را پاک کنید؟ این عمل غیرقابل بازگشت است.');
                    if (confirmed) {
                        this.clearAllData();
                    }
                });

                // Context menu
                document.addEventListener('contextmenu', (e) => {
                    const taskItem = e.target.closest('.task-item');
                    if (taskItem) {
                        e.preventDefault();
                        this.showContextMenu(e.pageX, e.pageY, taskItem.dataset.taskId);
                    }
                });

                document.addEventListener('click', () => {
                    this.hideContextMenu();
                    this.hideUserMenu();
                    this.hideNotificationPanel();
                });

                // Window events
                window.addEventListener('beforeunload', () => {
                    this.saveData();
                });

                window.addEventListener('resize', () => {
                    this.resizeCharts();
                });
            }

            setupKeyboardShortcuts() {
                document.addEventListener('keydown', (e) => {
                    // Ctrl/Cmd + N: New task
                    if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
                        e.preventDefault();
                        this.showTaskModal();
                    }
                    
                    // Ctrl/Cmd + F: Focus search
                    if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
                        e.preventDefault();
                        document.getElementById('globalSearch').focus();
                    }
                    
                    // Escape: Close modals
                    if (e.key === 'Escape') {
                        this.hideTaskModal();
                        this.hideContextMenu();
                        this.hideUserMenu();
                        this.hideNotificationPanel();
                    }
                });
            }

            // ================================
            // Rendering Methods
            // ================================
            
            render() {
                this.renderStats();
                this.renderTasks();
                this.renderTodayTasks();
                this.renderCalendar();
                this.renderAnalytics();
                this.renderCategories();
                this.renderNotifications();
                this.updateBulkActions();
                this.updateSettings();
            }

            switchTab(tabName) {
                // Update navigation
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.classList.remove('active');
                    item.classList.add('text-gray-600', 'dark:text-gray-400');
                });

                const activeTab = document.querySelector(`[data-tab="${tabName}"]`);
                if (activeTab) {
                    activeTab.classList.add('active');
                    activeTab.classList.remove('text-gray-600', 'dark:text-gray-400');
                }

                // Update content
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.add('hidden');
                });

                const activeContent = document.getElementById(`${tabName}Tab`);
                if (activeContent) {
                    activeContent.classList.remove('hidden');
                }

                this.currentView = tabName;

                // Render specific content
                switch (tabName) {
                    case 'dashboard':
                        this.renderStats();
                        this.renderTodayTasks();
                        this.renderRecentActivity();
                        break;
                    case 'tasks':
                        this.renderTasks();
                        break;
                    case 'calendar':
                        this.renderCalendar();
                        break;
                    case 'analytics':
                        this.renderAnalytics();
                        break;
                    case 'categories':
                        this.renderCategories();
                        break;
                    case 'settings':
                        this.updateSettings();
                        break;
                }
            }

            renderStats() {
                const total = this.tasks.length;
                const completed = this.tasks.filter(task => task.completed).length;
                const pending = this.tasks.filter(task => !task.completed).length;
                const overdue = this.tasks.filter(task => 
                    !task.completed && task.dueDate && new Date(task.dueDate) < new Date()
                ).length;

                document.getElementById('totalTasksCount').textContent = total;
                document.getElementById('completedTasksCount').textContent = completed;
                document.getElementById('pendingTasksCount').textContent = pending;
                document.getElementById('overdueTasksCount').textContent = overdue;

                // Update completion percentage
                const percentage = total > 0 ? Math.round((completed / total) * 100) : 0;
                document.getElementById('completionPercentage').textContent = `${percentage}%`;
                document.getElementById('progressBar').style.width = `${percentage}%`;

                this.renderWeeklyStats();
            }

            renderWeeklyStats() {
                const weeklyStatsContainer = document.getElementById('weeklyStats');
                if (!weeklyStatsContainer) return;

                const days = ['ش', 'ی', 'د', 'س', 'چ', 'پ', 'ج'];
                const today = new Date();
                const weekStart = new Date(today.getTime() - (today.getDay() * 24 * 60 * 60 * 1000));

                let html = '';
                for (let i = 0; i < 7; i++) {
                    const date = new Date(weekStart.getTime() + (i * 24 * 60 * 60 * 1000));
                    const dayTasks = this.tasks.filter(task => {
                        const taskDate = new Date(task.createdAt);
                        return taskDate.toDateString() === date.toDateString();
                    });
                    
                    const completedCount = dayTasks.filter(task => task.completed).length;
                    const totalCount = dayTasks.length;
                    const percentage = totalCount > 0 ? (completedCount / totalCount) * 100 : 0;

                    html += `
                        <div class="text-center">
                            <div class="text-xs text-gray-500 dark:text-gray-400 mb-1">${days[i]}</div>
                            <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                                <div class="bg-primary-500 h-2 rounded-full" style="width: ${percentage}%"></div>
                            </div>
                            <div class="text-xs text-gray-600 dark:text-gray-300 mt-1">${completedCount}/${totalCount}</div>
                        </div>
                    `;
                }
                
                weeklyStatsContainer.innerHTML = html;
            }

            renderTasks() {
                const filteredTasks = this.getFilteredTasks();
                const sortedTasks = this.getSortedTasks(filteredTasks);
                const paginatedTasks = this.getPaginatedTasks(sortedTasks);
                
                const container = document.getElementById('tasksList');
                const emptyState = document.getElementById('tasksEmptyState');
                const loadMoreContainer = document.getElementById('loadMoreContainer');

                if (sortedTasks.length === 0) {
                    container.innerHTML = '';
                    emptyState.classList.remove('hidden');
                    loadMoreContainer.classList.add('hidden');
                    return;
                }

                emptyState.classList.add('hidden');

                // Show/hide load more button
                const hasMoreTasks = sortedTasks.length > this.currentPage * this.tasksPerPage;
                if (hasMoreTasks) {
                    loadMoreContainer.classList.remove('hidden');
                } else {
                    loadMoreContainer.classList.add('hidden');
                }

                // Render tasks
                if (this.currentPage === 1) {
                    container.innerHTML = '';
                }

                paginatedTasks.forEach((task, index) => {
                    const taskElement = this.createTaskElement(task);
                    container.appendChild(taskElement);
                    
                    // Add entrance animation
                    setTimeout(() => {
                        taskElement.classList.add('animate-fade-in');
                    }, index * 50);
                });

                // Setup drag and drop
                if (this.currentPage === 1) {
                    this.setupDragAndDrop(container);
                }
            }

            createTaskElement(task) {
                const div = document.createElement('div');
                div.className = `task-item relative bg-white dark:bg-dark-card rounded-xl border border-gray-200 dark:border-dark-border p-4 priority-${task.priority} ${task.completed ? 'task-completed' : ''} cursor-pointer`;
                div.dataset.taskId = task.id;

                const isOverdue = task.dueDate && new Date(task.dueDate) < new Date() && !task.completed;
                const category = this.categories.find(c => c.id === task.category);
                const dueDate = task.dueDate ? new Date(task.dueDate) : null;

                div.innerHTML = `
                    <div class="priority-indicator"></div>
                    <div class="flex items-start space-x-4 space-x-reverse">
                        <input type="checkbox" 
                            ${task.completed ? 'checked' : ''} 
                            ${this.selectedTasks.has(task.id) ? 'checked' : ''}
                            class="custom-checkbox mt-1 task-checkbox" 
                            data-type="select">
                        
                        <input type="checkbox" 
                            ${task.completed ? 'checked' : ''} 
                            class="custom-checkbox mt-1 task-complete" 
                            data-type="complete">

                        <div class="flex-1 min-w-0">
                            <h3 class="task-title font-medium text-gray-900 dark:text-white ${task.completed ? 'line-through opacity-60' : ''} mb-1">
                                ${this.highlightSearchTerm(task.title)}
                                ${task.important ? '<i class="fas fa-star text-yellow-500 ml-1"></i>' : ''}
                            </h3>
                            
                            ${task.description ? `
                                <p class="text-sm text-gray-600 dark:text-gray-400 mb-2 ${task.completed ? 'opacity-60' : ''}">
                                    ${this.highlightSearchTerm(task.description)}
                                </p>
                            ` : ''}
                            
                            <div class="flex items-center flex-wrap gap-2 text-xs">
                                <span class="inline-flex items-center px-2 py-1 rounded-full text-white font-medium ${this.getPriorityClass(task.priority)}">
                                    ${this.getPriorityText(task.priority)}
                                </span>
                                
                                ${category ? `
                                    <span class="inline-flex items-center px-2 py-1 rounded-full bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300">
                                        <i class="${category.icon} ml-1"></i>${category.name}
                                    </span>
                                ` : ''}
                                
                                ${dueDate ? `
                                    <span class="inline-flex items-center px-2 py-1 rounded-full ${isOverdue ? 'bg-red-100 dark:bg-red-900 text-red-700 dark:text-red-300' : 'bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300'}">
                                        <i class="fas fa-clock ml-1"></i>
                                        ${this.formatDate(task.dueDate)}
                                        ${isOverdue ? ' (عقب‌افتاده)' : ''}
                                    </span>
                                ` : ''}
                                
                                ${task.repeat !== 'none' ? `
                                    <span class="inline-flex items-center px-2 py-1 rounded-full bg-purple-100 dark:bg-purple-900 text-purple-700 dark:text-purple-300">
                                        <i class="fas fa-redo ml-1"></i>${this.getRepeatText(task.repeat)}
                                    </span>
                                ` : ''}
                            </div>
                        </div>
                        
                        <div class="flex items-center space-x-1 space-x-reverse">
                            <button class="task-action p-2 text-gray-400 hover:text-primary-500 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors" 
                                data-action="edit" title="ویرایش">
                                <i class="fas fa-edit text-sm"></i>
                            </button>
                            <button class="task-action p-2 text-gray-400 hover:text-red-500 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors" 
                                data-action="delete" title="حذف">
                                <i class="fas fa-trash text-sm"></i>
                            </button>
                        </div>
                    </div>
                `;

                // Add event listeners
                this.setupTaskEventListeners(div, task);

                return div;
            }

            setupTaskEventListeners(element, task) {
                // Complete task
                const completeCheckbox = element.querySelector('.task-complete');
                completeCheckbox.addEventListener('change', (e) => {
                    e.stopPropagation();
                    this.updateTask(task.id, { completed: e.target.checked });
                });

                // Select task
                const selectCheckbox = element.querySelector('.task-checkbox');
                selectCheckbox.addEventListener('change', (e) => {
                    e.stopPropagation();
                    this.selectTask(task.id, e.target.checked);
                });

                // Task actions
                element.querySelectorAll('.task-action').forEach(button => {
                    button.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const action = button.dataset.action;
                        this.handleTaskAction(action, task.id);
                    });
                });

                // Click to edit
                element.addEventListener('click', (e) => {
                    if (!e.target.matches('input, button, .task-action')) {
                        this.editTask(task.id);
                    }
                });
            }

            handleTaskAction(action, taskId) {
                switch (action) {
                    case 'edit':
                        this.editTask(taskId);
                        break;
                    case 'delete':
                        this.confirmDeleteTask(taskId);
                        break;
                    case 'duplicate':
                        this.duplicateTask(taskId);
                        break;
                    case 'complete':
                        const task = this.tasks.find(t => t.id === taskId);
                        this.updateTask(taskId, { completed: !task.completed });
                        break;
                }
            }

            async confirmDeleteTask(taskId) {
                const task = this.tasks.find(t => t.id === taskId);
                if (!task) return;

                const confirmed = await this.showConfirm('حذف تسک', `آیا می‌خواهید تسک "${task.title}" را حذف کنید؟`);
                if (confirmed) {
                    this.deleteTask(taskId);
                }
            }

            setupDragAndDrop(container) {
                new Sortable(container, {
                    animation: 300,
                    ghostClass: 'sortable-ghost',
                    chosenClass: 'dragging',
                    onStart: (evt) => {
                        evt.item.classList.add('dragging');
                    },
                    onEnd: (evt) => {
                        evt.item.classList.remove('dragging');
                        // Update task order if needed
                        this.reorderTasks(evt.oldIndex, evt.newIndex);
                    }
                });
            }

            reorderTasks(oldIndex, newIndex) {
                const filteredTasks = this.getFilteredTasks();
                const sortedTasks = this.getSortedTasks(filteredTasks);
                
                if (oldIndex < sortedTasks.length && newIndex < sortedTasks.length) {
                    const movedTask = sortedTasks[oldIndex];
                    const targetTask = sortedTasks[newIndex];
                    
                    // Update order in original array
                    const movedIndex = this.tasks.findIndex(t => t.id === movedTask.id);
                    const targetIndex = this.tasks.findIndex(t => t.id === targetTask.id);
                    
                    if (movedIndex !== -1 && targetIndex !== -1) {
                        this.tasks.splice(movedIndex, 1);
                        this.tasks.splice(targetIndex, 0, movedTask);
                        this.saveData();
                    }
                }
            }

            renderTodayTasks() {
                const container = document.getElementById('todayTasksList');
                if (!container) return;

                const today = new Date();
                const todayTasks = this.tasks.filter(task => {
                    if (!task.dueDate) return false;
                    const dueDate = new Date(task.dueDate);
                    return dueDate.toDateString() === today.toDateString();
                });

                if (todayTasks.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-sm">تسکی برای امروز تعریف نشده</p>';
                    return;
                }

                container.innerHTML = todayTasks.slice(0, 5).map(task => `
                    <div class="flex items-center justify-between p-2 bg-gray-50 dark:bg-gray-700 rounded-lg">
                        <div class="flex items-center space-x-2 space-x-reverse">
                            <input type="checkbox" ${task.completed ? 'checked' : ''} 
                                class="custom-checkbox" 
                                onchange="taskManager.updateTask('${task.id}', { completed: this.checked })">
                            <span class="text-sm ${task.completed ? 'line-through opacity-60' : ''}">${task.title}</span>
                        </div>
                        <span class="text-xs px-2 py-1 rounded ${this.getPriorityClass(task.priority)}">${this.getPriorityText(task.priority)}</span>
                    </div>
                `).join('');
            }

            renderRecentActivity() {
                const container = document.getElementById('recentActivity');
                if (!container) return;

                // Get recent activities (created, completed, updated tasks)
                const activities = [];
                
                this.tasks
                    .sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt))
                    .slice(0, 10)
                    .forEach(task => {
                        if (task.completed && task.completedAt) {
                            activities.push({
                                type: 'completed',
                                task: task,
                                timestamp: task.completedAt,
                                text: `تسک "${task.title}" تکمیل شد`
                            });
                        } else {
                            activities.push({
                                type: 'created',
                                task: task,
                                timestamp: task.createdAt,
                                text: `تسک "${task.title}" ایجاد شد`
                            });
                        }
                    });

                activities.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

                if (activities.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-sm">فعالیت اخیری وجود ندارد</p>';
                    return;
                }

                container.innerHTML = activities.slice(0, 5).map(activity => `
                    <div class="flex items-center space-x-3 space-x-reverse p-2">
                        <div class="w-8 h-8 rounded-full flex items-center justify-center ${activity.type === 'completed' ? 'bg-green-100 dark:bg-green-900' : 'bg-blue-100 dark:bg-blue-900'}">
                            <i class="fas ${activity.type === 'completed' ? 'fa-check text-green-600 dark:text-green-400' : 'fa-plus text-blue-600 dark:text-blue-400'} text-sm"></i>
                        </div>
                        <div class="flex-1">
                            <p class="text-sm text-gray-900 dark:text-white">${activity.text}</p>
                            <p class="text-xs text-gray-500 dark:text-gray-400">${this.formatRelativeTime(activity.timestamp)}</p>
                        </div>
                    </div>
                `).join('');
            }

            renderCalendar() {
                const container = document.getElementById('calendar');
                if (!container) return;

                const now = new Date();
                const year = now.getFullYear();
                const month = now.getMonth();
                
                // Update month display
                const monthNames = [
                    'ژانویه', 'فوریه', 'مارس', 'آوریل', 'مه', 'ژوئن',
                    'ژوئیه', 'اوت', 'سپتامبر', 'اکتبر', 'نوامبر', 'دسامبر'
                ];
                document.getElementById('currentMonth').textContent = `${monthNames[month]} ${year}`;

                // Generate calendar
                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                const daysInMonth = lastDay.getDate();
                const startDayOfWeek = firstDay.getDay();

                let html = '';
                
                // Day headers
                const dayHeaders = ['ش', 'ی', 'د', 'س', 'چ', 'پ', 'ج'];
                dayHeaders.forEach(day => {
                    html += `<div class="p-2 text-center text-sm font-medium text-gray-500 dark:text-gray-400">${day}</div>`;
                });

                // Empty cells for previous month
                for (let i = 0; i < startDayOfWeek; i++) {
                    html += '<div></div>';
                }

                // Days of current month
                for (let day = 1; day <= daysInMonth; day++) {
                    const date = new Date(year, month, day);
                    const isToday = date.toDateString() === now.toDateString();
                    
                    const dayTasks = this.tasks.filter(task => {
                        if (!task.dueDate) return false;
                        const taskDate = new Date(task.dueDate);
                        return taskDate.toDateString() === date.toDateString();
                    });

                    html += `
                        <div class="calendar-day p-2 text-center text-sm cursor-pointer rounded-lg border ${isToday ? 'today' : ''} ${dayTasks.length > 0 ? 'has-tasks' : ''}" 
                             data-date="${date.toISOString().split('T')[0]}">
                            ${day}
                        </div>
                    `;
                }

                container.innerHTML = html;

                // Add click listeners
                container.querySelectorAll('.calendar-day').forEach(day => {
                    day.addEventListener('click', (e) => {
                        const date = e.target.dataset.date;
                        if (date) {
                            this.showCalendarTasks(date);
                        }
                    });
                });
            }

            showCalendarTasks(dateString) {
                const container = document.getElementById('calendarTasksList');
                if (!container) return;

                const date = new Date(dateString);
                const dayTasks = this.tasks.filter(task => {
                    if (!task.dueDate) return false;
                    const taskDate = new Date(task.dueDate);
                    return taskDate.toDateString() === date.toDateString();
                });

                const dateTitle = new Intl.DateTimeFormat('fa-IR', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                }).format(date);

                if (dayTasks.length === 0) {
                    container.innerHTML = `
                        <h4 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">${dateTitle}</h4>
                        <p class="text-gray-500 dark:text-gray-400">تسکی برای این روز تعریف نشده</p>
                    `;
                    return;
                }

                container.innerHTML = `
                    <h4 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">${dateTitle}</h4>
                    <div class="space-y-3">
                        ${dayTasks.map(task => `
                            <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                                <div class="flex items-center space-x-3 space-x-reverse">
                                    <input type="checkbox" ${task.completed ? 'checked' : ''} 
                                        class="custom-checkbox" 
                                        onchange="taskManager.updateTask('${task.id}', { completed: this.checked })">
                                    <div>
                                        <span class="text-sm font-medium ${task.completed ? 'line-through opacity-60' : ''}">${task.title}</span>
                                        <div class="flex items-center space-x-2 space-x-reverse mt-1">
                                            <span class="text-xs px-2 py-1 rounded ${this.getPriorityClass(task.priority)}">${this.getPriorityText(task.priority)}</span>
                                            ${task.dueDate ? `<span class="text-xs text-gray-500">${this.formatTime(task.dueDate)}</span>` : ''}
                                        </div>
                                    </div>
                                </div>
                                <button onclick="taskManager.editTask('${task.id}')" 
                                    class="text-gray-400 hover:text-primary-500 transition-colors">
                                    <i class="fas fa-edit"></i>
                                </button>
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            renderAnalytics() {
                this.renderCompletionChart();
                this.renderPriorityChart();
                this.renderCategoryStats();
                this.renderTimeAnalysis();
            }

            renderCompletionChart() {
                const canvas = document.getElementById('completionChart');
                if (!canvas) return;

                const ctx = canvas.getContext('2d');
                
                // Destroy existing chart
                if (this.charts.completion) {
                    this.charts.completion.destroy();
                }

                // Get last 7 days data
                const last7Days = [];
                const today = new Date();
                
                for (let i = 6; i >= 0; i--) {
                    const date = new Date(today.getTime() - (i * 24 * 60 * 60 * 1000));
                    const dayTasks = this.tasks.filter(task => {
                        const taskDate = new Date(task.createdAt);
                        return taskDate.toDateString() === date.toDateString();
                    });
                    
                    const completed = dayTasks.filter(task => task.completed).length;
                    const total = dayTasks.length;
                    
                    last7Days.push({
                        date: date.toLocaleDateString('fa-IR', { month: 'short', day: 'numeric' }),
                        completed,
                        total,
                        percentage: total > 0 ? (completed / total) * 100 : 0
                    });
                }

                this.charts.completion = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: last7Days.map(d => d.date),
                        datasets: [{
                            label: 'درصد تکمیل',
                            data: last7Days.map(d => d.percentage),
                            borderColor: '#5D5CDE',
                            backgroundColor: 'rgba(93, 92, 222, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                ticks: {
                                    callback: function(value) {
                                        return value + '%';
                                    }
                                }
                            }
                        }
                    }
                });
            }

            renderPriorityChart() {
                const canvas = document.getElementById('priorityChart');
                if (!canvas) return;

                const ctx = canvas.getContext('2d');
                
                // Destroy existing chart
                if (this.charts.priority) {
                    this.charts.priority.destroy();
                }

                const priorities = { high: 0, medium: 0, low: 0 };
                this.tasks.forEach(task => {
                    priorities[task.priority]++;
                });

                this.charts.priority = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['بالا', 'متوسط', 'پایین'],
                        datasets: [{
                            data: [priorities.high, priorities.medium, priorities.low],
                            backgroundColor: ['#ef4444', '#f59e0b', '#10b981'],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            }

            renderCategoryStats() {
                const container = document.getElementById('categoryStats');
                if (!container) return;

                const categoryCount = {};
                this.tasks.forEach(task => {
                    categoryCount[task.category] = (categoryCount[task.category] || 0) + 1;
                });

                container.innerHTML = this.categories.map(category => {
                    const count = categoryCount[category.id] || 0;
                    const completed = this.tasks.filter(task => 
                        task.category === category.id && task.completed
                    ).length;
                    const percentage = count > 0 ? (completed / count) * 100 : 0;

                    return `
                        <div class="bg-white dark:bg-dark-surface rounded-lg p-4 border border-gray-200 dark:border-gray-600">
                            <div class="flex items-center justify-between mb-3">
                                <div class="flex items-center space-x-2 space-x-reverse">
                                    <i class="${category.icon}" style="color: ${category.color}"></i>
                                    <span class="font-medium text-gray-900 dark:text-white">${category.name}</span>
                                </div>
                                <span class="text-lg font-bold text-gray-900 dark:text-white">${count}</span>
                            </div>
                            <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                                <div class="h-2 rounded-full" style="width: ${percentage}%; background-color: ${category.color}"></div>
                            </div>
                            <div class="flex justify-between text-xs text-gray-500 dark:text-gray-400 mt-2">
                                <span>${completed} تکمیل شده</span>
                                <span>${Math.round(percentage)}%</span>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            renderTimeAnalysis() {
                const completedTasks = this.tasks.filter(task => task.completed && task.completedAt);
                
                // Average completion time
                let totalDays = 0;
                completedTasks.forEach(task => {
                    const created = new Date(task.createdAt);
                    const completed = new Date(task.completedAt);
                    const diffInDays = (completed - created) / (1000 * 60 * 60 * 24);
                    totalDays += diffInDays;
                });
                
                const avgCompletionTime = completedTasks.length > 0 ? 
                    Math.round(totalDays / completedTasks.length) : 0;

                // On-time completion percentage
                const tasksWithDueDate = this.tasks.filter(task => task.dueDate && task.completed);
                const onTimeTasks = tasksWithDueDate.filter(task => {
                    const dueDate = new Date(task.dueDate);
                    const completedDate = new Date(task.completedAt);
                    return completedDate <= dueDate;
                });
                
                const onTimePercentage = tasksWithDueDate.length > 0 ? 
                    Math.round((onTimeTasks.length / tasksWithDueDate.length) * 100) : 0;

                // Productivity score (simple calculation based on completion rate and on-time delivery)
                const completionRate = this.tasks.length > 0 ? 
                    (completedTasks.length / this.tasks.length) * 100 : 0;
                const productivityScore = Math.round((completionRate + onTimePercentage) / 2);

                document.getElementById('avgCompletionTime').textContent = avgCompletionTime;
                document.getElementById('onTimeCompletion').textContent = `${onTimePercentage}%`;
                document.getElementById('productivityScore').textContent = productivityScore;
            }

            renderCategories() {
                const container = document.getElementById('categoriesList');
                if (!container) return;

                container.innerHTML = this.categories.map(category => {
                    const taskCount = this.tasks.filter(task => task.category === category.id).length;
                    const completedCount = this.tasks.filter(task => 
                        task.category === category.id && task.completed
                    ).length;

                    return `
                        <div class="bg-white dark:bg-dark-card rounded-xl p-6 border border-gray-200 dark:border-dark-border">
                            <div class="flex items-center justify-between mb-4">
                                <div class="flex items-center space-x-3 space-x-reverse">
                                    <div class="w-12 h-12 rounded-lg flex items-center justify-center" style="background-color: ${category.color}20;">
                                        <i class="${category.icon} text-xl" style="color: ${category.color}"></i>
                                    </div>
                                    <div>
                                        <h4 class="font-semibold text-gray-900 dark:text-white">${category.name}</h4>
                                        <p class="text-sm text-gray-500 dark:text-gray-400">${taskCount} تسک</p>
                                    </div>
                                </div>
                                <button class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200">
                                    <i class="fas fa-edit"></i>
                                </button>
                            </div>
                            
                            <div class="space-y-2">
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-600 dark:text-gray-400">پیشرفت</span>
                                    <span class="font-medium">${completedCount}/${taskCount}</span>
                                </div>
                                <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                                    <div class="h-2 rounded-full" 
                                        style="width: ${taskCount > 0 ? (completedCount / taskCount) * 100 : 0}%; background-color: ${category.color}"></div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            renderNotifications() {
                const container = document.getElementById('notificationList');
                if (!container) return;

                if (this.notifications.length === 0) {
                    container.innerHTML = '<div class="p-4 text-center text-gray-500 dark:text-gray-400">اعلانی وجود ندارد</div>';
                    return;
                }

                container.innerHTML = this.notifications.slice(0, 10).map(notification => `
                    <div class="p-4 border-b border-gray-200 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700 cursor-pointer ${notification.read ? 'opacity-60' : ''}"
                         onclick="taskManager.markNotificationAsRead('${notification.id}')">
                        <div class="flex items-start space-x-3 space-x-reverse">
                            <div class="w-8 h-8 rounded-full flex items-center justify-center ${this.getNotificationColor(notification.type)}">
                                <i class="fas ${this.getNotificationIcon(notification.type)} text-sm"></i>
                            </div>
                            <div class="flex-1">
                                <h5 class="font-medium text-gray-900 dark:text-white">${notification.title}</h5>
                                <p class="text-sm text-gray-600 dark:text-gray-400">${notification.message}</p>
                                <p class="text-xs text-gray-500 dark:text-gray-500 mt-1">${this.formatRelativeTime(notification.timestamp)}</p>
                            </div>
                        </div>
                    </div>
                `).join('');
            }

            updateSettings() {
                document.getElementById('autoTheme').checked = this.settings.autoTheme;
                document.getElementById('enableNotifications').checked = this.settings.notifications;
                document.getElementById('notificationSound').checked = this.settings.notificationSound;
                document.getElementById('lastUpdateDate').textContent = new Date().toLocaleDateString('fa-IR');
            }

            // ================================
            // Modal Management
            // ================================
            
            showTaskModal(taskId = null) {
                const modal = document.getElementById('taskModal');
                const form = document.getElementById('taskModalForm');
                const title = document.getElementById('modalTitle');
                
                this.currentEditingTask = taskId;
                
                if (taskId) {
                    const task = this.tasks.find(t => t.id === taskId);
                    if (task) {
                        title.textContent = 'ویرایش تسک';
                        this.fillTaskForm(task);
                    }
                } else {
                    title.textContent = 'تسک جدید';
                    form.reset();
                }
                
                modal.classList.remove('hidden');
                document.getElementById('modalTaskTitle').focus();
            }

            hideTaskModal() {
                document.getElementById('taskModal').classList.add('hidden');
                this.currentEditingTask = null;
            }

            fillTaskForm(task) {
                document.getElementById('modalTaskTitle').value = task.title;
                document.getElementById('modalTaskDescription').value = task.description || '';
                document.getElementById('modalTaskCategory').value = task.category;
                document.getElementById('modalTaskPriority').value = task.priority;
                document.getElementById('modalTaskDueDate').value = task.dueDate ? task.dueDate.slice(0, 16) : '';
                document.getElementById('modalTaskReminder').value = task.reminder ? task.reminder.slice(0, 16) : '';
                document.getElementById('modalTaskRepeat').value = task.repeat;
                document.getElementById('modalTaskImportant').checked = task.important || false;
            }

            handleTaskSubmit(e) {
                e.preventDefault();
                
                const formData = new FormData(e.target);
                const taskData = {
                    title: document.getElementById('modalTaskTitle').value.trim(),
                    description: document.getElementById('modalTaskDescription').value.trim(),
                    category: document.getElementById('modalTaskCategory').value,
                    priority: document.getElementById('modalTaskPriority').value,
                    dueDate: document.getElementById('modalTaskDueDate').value || null,
                    reminder: document.getElementById('modalTaskReminder').value || null,
                    repeat: document.getElementById('modalTaskRepeat').value,
                    important: document.getElementById('modalTaskImportant').checked
                };

                if (!taskData.title) {
                    this.showToast('لطفاً عنوان تسک را وارد کنید', 'error');
                    return;
                }

                if (this.currentEditingTask) {
                    this.updateTask(this.currentEditingTask, taskData);
                    this.showToast('تسک به‌روزرسانی شد', 'success');
                } else {
                    this.addTask(taskData);
                }

                this.hideTaskModal();
            }

            editTask(taskId) {
                this.showTaskModal(taskId);
            }

            // ================================
            // Context Menu
            // ================================
            
            showContextMenu(x, y, taskId) {
                const menu = document.getElementById('contextMenu');
                const task = this.tasks.find(t => t.id === taskId);
                
                if (!task) return;

                // Update menu items based on task state
                const completeItem = menu.querySelector('[data-action="complete"]');
                completeItem.innerHTML = task.completed ? 
                    '<i class="fas fa-undo ml-2"></i>بازگردانی' : 
                    '<i class="fas fa-check ml-2"></i>تکمیل';

                menu.style.left = `${x}px`;
                menu.style.top = `${y}px`;
                menu.classList.remove('hidden');

                // Add event listeners
                menu.querySelectorAll('.context-menu-item').forEach(item => {
                    item.onclick = (e) => {
                        e.stopPropagation();
                        const action = item.dataset.action;
                        this.handleTaskAction(action, taskId);
                        this.hideContextMenu();
                    };
                });
            }

            hideContextMenu() {
                document.getElementById('contextMenu').classList.add('hidden');
            }

            // ================================
            // Utility Methods
            // ================================
            
            formatDate(dateString) {
                if (!dateString) return '';
                const date = new Date(dateString);
                return new Intl.DateTimeFormat('fa-IR', {
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                }).format(date);
            }

            formatTime(dateString) {
                if (!dateString) return '';
                const date = new Date(dateString);
                return new Intl.DateTimeFormat('fa-IR', {
                    hour: '2-digit',
                    minute: '2-digit'
                }).format(date);
            }

            formatRelativeTime(dateString) {
                const date = new Date(dateString);
                const now = new Date();
                const diffInMinutes = Math.floor((now - date) / (1000 * 60));
                
                if (diffInMinutes < 1) return 'همین الان';
                if (diffInMinutes < 60) return `${diffInMinutes} دقیقه پیش`;
                
                const diffInHours = Math.floor(diffInMinutes / 60);
                if (diffInHours < 24) return `${diffInHours} ساعت پیش`;
                
                const diffInDays = Math.floor(diffInHours / 24);
                if (diffInDays < 30) return `${diffInDays} روز پیش`;
                
                return this.formatDate(dateString);
            }

            highlightSearchTerm(text) {
                if (!this.searchQuery) return text;
                const regex = new RegExp(`(${this.escapeRegex(this.searchQuery)})`, 'gi');
                return text.replace(regex, '<span class="search-highlight">$1</span>');
            }

            escapeRegex(string) {
                return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            }

            getPriorityClass(priority) {
                const classes = {
                    high: 'bg-red-500',
                    medium: 'bg-yellow-500',
                    low: 'bg-green-500'
                };
                return classes[priority] || classes.medium;
            }

            getPriorityText(priority) {
                const texts = {
                    high: 'بالا',
                    medium: 'متوسط',
                    low: 'پایین'
                };
                return texts[priority] || texts.medium;
            }

            getRepeatText(repeat) {
                const texts = {
                    daily: 'روزانه',
                    weekly: 'هفتگی',
                    monthly: 'ماهانه'
                };
                return texts[repeat] || '';
            }

            getNotificationColor(type) {
                const colors = {
                    success: 'bg-green-100 dark:bg-green-900 text-green-600 dark:text-green-400',
                    error: 'bg-red-100 dark:bg-red-900 text-red-600 dark:text-red-400',
                    warning: 'bg-yellow-100 dark:bg-yellow-900 text-yellow-600 dark:text-yellow-400',
                    info: 'bg-blue-100 dark:bg-blue-900 text-blue-600 dark:text-blue-400'
                };
                return colors[type] || colors.info;
            }

            getNotificationIcon(type) {
                const icons = {
                    success: 'fa-check',
                    error: 'fa-exclamation-triangle',
                    warning: 'fa-exclamation',
                    info: 'fa-info'
                };
                return icons[type] || icons.info;
            }

            // ================================
            // UI Helper Methods
            // ================================
            
            toggleNotificationPanel() {
                const panel = document.getElementById('notificationPanel');
                panel.classList.toggle('hidden');
                if (!panel.classList.contains('hidden')) {
                    this.renderNotifications();
                }
            }

            hideNotificationPanel() {
                document.getElementById('notificationPanel').classList.add('hidden');
            }

            toggleUserMenu() {
                const menu = document.getElementById('userDropdown');
                menu.classList.toggle('hidden');
            }

            hideUserMenu() {
                document.getElementById('userDropdown').classList.add('hidden');
            }

            resizeCharts() {
                Object.values(this.charts).forEach(chart => {
                    if (chart && chart.resize) {
                        chart.resize();
                    }
                });
            }

            // ================================
            // Data Import/Export
            // ================================
            
            exportData() {
                const data = {
                    tasks: this.tasks,
                    categories: this.categories,
                    settings: this.settings,
                    exportDate: new Date().toISOString(),
                    version: '2.0.0'
                };

                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `tasks-backup-${new Date().toISOString().slice(0, 10)}.json`;
                a.click();
                URL.revokeObjectURL(url);
                
                this.showToast('پشتیبان گرفته شد', 'success');
            }

            importData(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        
                        if (data.tasks) {
                            this.tasks = data.tasks;
                        }
                        if (data.settings) {
                            this.settings = { ...this.settings, ...data.settings };
                        }
                        if (data.categories) {
                            this.categories = data.categories;
                        }
                        
                        this.saveData();
                        this.render();
                        this.showToast('داده‌ها بازیابی شد', 'success');
                    } catch (error) {
                        this.showToast('خطا در بازیابی داده‌ها', 'error');
                    }
                };
                reader.readAsText(file);
                event.target.value = '';
            }

            clearAllData() {
                this.tasks = [];
                this.notifications = [];
                this.selectedTasks.clear();
                this.settings = {
                    theme: 'light',
                    autoTheme: true,
                    notifications: false,
                    notificationSound: true,
                    language: 'fa'
                };
                
                this.saveData();
                this.render();
                this.showToast('تمام داده‌ها پاک شد', 'info');
            }
        }

        // ================================
        // Initialize Application
        // ================================
        
        let taskManager;
        
        document.addEventListener('DOMContentLoaded', () => {
            taskManager = new TaskManager();
            window.taskManager = taskManager; // For global access
        });

        // Make some methods globally accessible for inline event handlers
        window.showTaskModal = () => taskManager.showTaskModal();
    </script>


</body></html>