<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مدیریت تسک‌ها - Task Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                        'dark-bg': '#181818',
                        'dark-card': '#2D2D2D'
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@100;200;300;400;500;600;700;800;900&display=swap');
        * {
            font-family: 'Vazirmatn', sans-serif;
        }
        
        .task-item {
            transition: all 0.3s ease;
        }
        
        .task-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .task-completed {
            opacity: 0.6;
            text-decoration: line-through;
        }
        
        .priority-high {
            border-right: 4px solid #ef4444;
        }
        
        .priority-medium {
            border-right: 4px solid #f59e0b;
        }
        
        .priority-low {
            border-right: 4px solid #10b981;
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .slide-out {
            animation: slideOut 0.3s ease-out forwards;
        }
        
        @keyframes slideOut {
            from { opacity: 1; transform: translateX(0); }
            to { opacity: 0; transform: translateX(100%); }
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            transition: all 0.3s ease;
        }
        
        .sortable-ghost {
            opacity: 0.4;
        }
        
        .tab-active {
            background: linear-gradient(135deg, #5D5CDE, #7C3AED);
            color: white;
        }
        
        .dark .task-item {
            background: #2D2D2D;
            border-color: #4B5563;
        }
        
        .dark .task-item:hover {
            box-shadow: 0 4px 12px rgba(255,255,255,0.1);
        }
    </style>
</head>
<body class="bg-white dark:bg-dark-bg min-h-screen transition-colors duration-300">
    <!-- Header -->
    <header class="bg-white dark:bg-dark-card shadow-md border-b dark:border-gray-700">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <i class="fas fa-tasks text-primary text-2xl ml-3"></i>
                    <h1 class="text-xl font-bold text-gray-900 dark:text-white">مدیریت تسک‌ها</h1>
                </div>
                <div class="flex items-center space-x-4 space-x-reverse">
                    <button id="themeToggle" class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                        <i class="fas fa-moon dark:fa-sun text-gray-600 dark:text-gray-300"></i>
                    </button>
                    <button id="notificationToggle" class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                        <i class="fas fa-bell text-gray-600 dark:text-gray-300"></i>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Container -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Tabs Navigation -->
        <div class="flex space-x-1 space-x-reverse bg-gray-100 dark:bg-gray-800 p-1 rounded-lg mb-8">
            <button class="tab-btn tab-active flex-1 py-2 px-4 rounded-md text-sm font-medium transition-all" data-tab="tasks">
                <i class="fas fa-list ml-2"></i>تسک‌ها
            </button>
            <button class="tab-btn flex-1 py-2 px-4 rounded-md text-sm font-medium transition-all text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white" data-tab="today">
                <i class="fas fa-calendar-day ml-2"></i>امروز
            </button>
            <button class="tab-btn flex-1 py-2 px-4 rounded-md text-sm font-medium transition-all text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white" data-tab="analytics">
                <i class="fas fa-chart-bar ml-2"></i>گزارشات
            </button>
            <button class="tab-btn flex-1 py-2 px-4 rounded-md text-sm font-medium transition-all text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white" data-tab="settings">
                <i class="fas fa-cog ml-2"></i>تنظیمات
            </button>
        </div>

        <!-- Tasks Tab -->
        <div id="tasksTab" class="tab-content">
            <!-- Quick Add Task Form -->
            <div class="bg-white dark:bg-dark-card rounded-lg shadow-md p-6 mb-8 border dark:border-gray-700">
                <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">
                    <i class="fas fa-plus-circle text-primary ml-2"></i>افزودن تسک جدید
                </h2>
                <form id="taskForm" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <input type="text" id="taskTitle" placeholder="عنوان تسک..." 
                                class="w-full px-4 py-3 text-base border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:text-white transition-all" required>
                        </div>
                        <div>
                            <select id="taskPriority" 
                                class="w-full px-4 py-3 text-base border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:text-white">
                                <option value="low">اولویت پایین</option>
                                <option value="medium">اولویت متوسط</option>
                                <option value="high">اولویت بالا</option>
                            </select>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <input type="datetime-local" id="taskDueDate"
                                class="w-full px-4 py-3 text-base border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:text-white">
                        </div>
                        <div>
                            <select id="taskRepeat"
                                class="w-full px-4 py-3 text-base border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:text-white">
                                <option value="none">بدون تکرار</option>
                                <option value="daily">روزانه</option>
                                <option value="weekly">هفتگی</option>
                                <option value="monthly">ماهانه</option>
                            </select>
                        </div>
                        <div>
                            <input type="datetime-local" id="taskReminder" placeholder="یادآوری"
                                class="w-full px-4 py-3 text-base border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:text-white">
                        </div>
                    </div>
                    <div>
                        <textarea id="taskDescription" placeholder="توضیحات (اختیاری)..." rows="3"
                            class="w-full px-4 py-3 text-base border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:text-white resize-none"></textarea>
                    </div>
                    <button type="submit" 
                        class="w-full bg-primary hover:bg-purple-600 text-white font-medium py-3 px-6 rounded-lg transition-colors">
                        <i class="fas fa-plus ml-2"></i>افزودن تسک
                    </button>
                </form>
            </div>

            <!-- Filters and Sort -->
            <div class="flex flex-wrap items-center justify-between mb-6 gap-4">
                <div class="flex items-center space-x-4 space-x-reverse">
                    <select id="statusFilter" class="px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white">
                        <option value="all">همه وضعیت‌ها</option>
                        <option value="pending">در انتظار</option>
                        <option value="done">انجام شده</option>
                    </select>
                    <select id="priorityFilter" class="px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white">
                        <option value="all">همه اولویت‌ها</option>
                        <option value="high">اولویت بالا</option>
                        <option value="medium">اولویت متوسط</option>
                        <option value="low">اولویت پایین</option>
                    </select>
                </div>
                <div class="flex items-center space-x-2 space-x-reverse">
                    <span class="text-sm text-gray-600 dark:text-gray-400">مرتب‌سازی:</span>
                    <select id="sortBy" class="px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white">
                        <option value="priority">اولویت</option>
                        <option value="dueDate">زمان انجام</option>
                        <option value="createdAt">تاریخ ایجاد</option>
                    </select>
                </div>
            </div>

            <!-- Tasks List -->
            <div id="tasksList" class="space-y-4">
                <!-- Tasks will be rendered here -->
            </div>
        </div>

        <!-- Today Tab -->
        <div id="todayTab" class="tab-content hidden">
            <div class="bg-white dark:bg-dark-card rounded-lg shadow-md p-6 border dark:border-gray-700">
                <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-6">
                    <i class="fas fa-calendar-day text-primary ml-2"></i>تسک‌های امروز
                </h2>
                <div id="todayTasks" class="space-y-4">
                    <!-- Today's tasks will be rendered here -->
                </div>
            </div>
        </div>

        <!-- Analytics Tab -->
        <div id="analyticsTab" class="tab-content hidden">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="bg-white dark:bg-dark-card rounded-lg shadow-md p-6 border dark:border-gray-700">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-blue-100 dark:bg-blue-900">
                            <i class="fas fa-tasks text-blue-600 dark:text-blue-300"></i>
                        </div>
                        <div class="mr-4">
                            <p class="text-sm font-medium text-gray-600 dark:text-gray-400">کل تسک‌ها</p>
                            <p id="totalTasks" class="text-2xl font-bold text-gray-900 dark:text-white">0</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white dark:bg-dark-card rounded-lg shadow-md p-6 border dark:border-gray-700">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-green-100 dark:bg-green-900">
                            <i class="fas fa-check text-green-600 dark:text-green-300"></i>
                        </div>
                        <div class="mr-4">
                            <p class="text-sm font-medium text-gray-600 dark:text-gray-400">انجام شده</p>
                            <p id="completedTasks" class="text-2xl font-bold text-gray-900 dark:text-white">0</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white dark:bg-dark-card rounded-lg shadow-md p-6 border dark:border-gray-700">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-orange-100 dark:bg-orange-900">
                            <i class="fas fa-clock text-orange-600 dark:text-orange-300"></i>
                        </div>
                        <div class="mr-4">
                            <p class="text-sm font-medium text-gray-600 dark:text-gray-400">در انتظار</p>
                            <p id="pendingTasks" class="text-2xl font-bold text-gray-900 dark:text-white">0</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings Tab -->
        <div id="settingsTab" class="tab-content hidden">
            <div class="bg-white dark:bg-dark-card rounded-lg shadow-md p-6 border dark:border-gray-700">
                <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-6">
                    <i class="fas fa-cog text-primary ml-2"></i>تنظیمات
                </h2>
                <div class="space-y-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="text-lg font-medium text-gray-900 dark:text-white">نوتیفیکیشن‌ها</h3>
                            <p class="text-sm text-gray-600 dark:text-gray-400">دریافت یادآوری برای تسک‌ها</p>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="notificationSetting" class="sr-only peer">
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-primary/20 dark:peer-focus:ring-primary/30 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-primary"></div>
                        </label>
                    </div>
                    <div class="border-t dark:border-gray-700 pt-6">
                        <button id="clearAllData" class="w-full bg-red-500 hover:bg-red-600 text-white font-medium py-3 px-6 rounded-lg transition-colors">
                            <i class="fas fa-trash ml-2"></i>پاک کردن تمام داده‌ها
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification Container -->
    <div id="notificationContainer"></div>

    <!-- Confirmation Modal -->
    <div id="confirmModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white dark:bg-dark-card p-6 rounded-lg shadow-lg max-w-sm w-full mx-4">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4" id="confirmTitle">تأیید عملیات</h3>
            <p class="text-gray-700 dark:text-gray-300 mb-6" id="confirmMessage">آیا مطمئن هستید؟</p>
            <div class="flex justify-end space-x-3 space-x-reverse">
                <button id="confirmCancel" class="px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded transition-colors">لغو</button>
                <button id="confirmOk" class="px-4 py-2 bg-red-500 text-white hover:bg-red-600 rounded transition-colors">تأیید</button>
            </div>
        </div>
    </div>

    <script>
        // App Data Structure
        let appData = {
            tasks: [],
            settings: {
                theme: 'light',
                notificationsEnabled: true
            }
        };

        // DOM Elements
        const taskForm = document.getElementById('taskForm');
        const tasksList = document.getElementById('tasksList');
        const todayTasks = document.getElementById('todayTasks');
        const themeToggle = document.getElementById('themeToggle');
        const notificationToggle = document.getElementById('notificationToggle');
        const tabBtns = document.querySelectorAll('.tab-btn');
        const tabContents = document.querySelectorAll('.tab-content');
        const statusFilter = document.getElementById('statusFilter');
        const priorityFilter = document.getElementById('priorityFilter');
        const sortBy = document.getElementById('sortBy');
        const confirmModal = document.getElementById('confirmModal');
        const confirmTitle = document.getElementById('confirmTitle');
        const confirmMessage = document.getElementById('confirmMessage');
        const confirmOk = document.getElementById('confirmOk');
        const confirmCancel = document.getElementById('confirmCancel');

        // Utility Functions
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return new Intl.DateTimeFormat('fa-IR', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            }).format(date);
        }

        function isToday(dateString) {
            if (!dateString) return false;
            const today = new Date();
            const date = new Date(dateString);
            return date.toDateString() === today.toDateString();
        }

        function isPastDue(dateString) {
            if (!dateString) return false;
            return new Date(dateString) < new Date();
        }

        // Storage Functions
        function saveData() {
            localStorage.setItem('taskManagerData', JSON.stringify(appData));
        }

        function loadData() {
            try {
                const saved = localStorage.getItem('taskManagerData');
                if (saved) {
                    appData = JSON.parse(saved);
                }
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }

        // Theme Management
        function initTheme() {
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.documentElement.classList.add('dark');
                appData.settings.theme = 'dark';
            }
            
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
                if (event.matches) {
                    document.documentElement.classList.add('dark');
                    appData.settings.theme = 'dark';
                } else {
                    document.documentElement.classList.remove('dark');
                    appData.settings.theme = 'light';
                }
                saveData();
            });

            if (appData.settings.theme === 'dark') {
                document.documentElement.classList.add('dark');
            }
        }

        function toggleTheme() {
            document.documentElement.classList.toggle('dark');
            appData.settings.theme = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
            saveData();
        }

        // Notification Functions
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification bg-white dark:bg-dark-card border dark:border-gray-700 rounded-lg shadow-lg p-4 max-w-sm transform translate-x-full`;
            
            const colors = {
                success: 'text-green-600',
                error: 'text-red-600',
                warning: 'text-yellow-600',
                info: 'text-blue-600'
            };

            const icons = {
                success: 'fa-check-circle',
                error: 'fa-exclamation-circle',
                warning: 'fa-exclamation-triangle',
                info: 'fa-info-circle'
            };

            notification.innerHTML = `
                <div class="flex items-center">
                    <i class="fas ${icons[type]} ${colors[type]} ml-3"></i>
                    <span class="text-gray-900 dark:text-white">${message}</span>
                </div>
            `;

            document.getElementById('notificationContainer').appendChild(notification);

            // Animate in
            setTimeout(() => {
                notification.style.transform = 'translateX(0)';
            }, 100);

            // Remove after 3 seconds
            setTimeout(() => {
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }, 3000);
        }

        async function requestNotificationPermission() {
            if ('Notification' in window && Notification.permission === 'default') {
                const permission = await Notification.requestPermission();
                return permission === 'granted';
            }
            return Notification.permission === 'granted';
        }

        function showBrowserNotification(title, body) {
            if ('Notification' in window && Notification.permission === 'granted' && appData.settings.notificationsEnabled) {
                new Notification(title, {
                    body: body,
                    icon: '/favicon.ico'
                });
            }
        }

        // Confirmation Modal
        function showConfirmDialog(title, message) {
            return new Promise((resolve) => {
                confirmTitle.textContent = title;
                confirmMessage.textContent = message;
                confirmModal.classList.remove('hidden');

                function handleConfirm() {
                    confirmModal.classList.add('hidden');
                    confirmOk.removeEventListener('click', handleConfirm);
                    confirmCancel.removeEventListener('click', handleCancel);
                    resolve(true);
                }

                function handleCancel() {
                    confirmModal.classList.add('hidden');
                    confirmOk.removeEventListener('click', handleConfirm);
                    confirmCancel.removeEventListener('click', handleCancel);
                    resolve(false);
                }

                confirmOk.addEventListener('click', handleConfirm);
                confirmCancel.addEventListener('click', handleCancel);
            });
        }

        // Task Management
        function addTask(taskData) {
            const task = {
                id: generateId(),
                title: taskData.title,
                description: taskData.description || '',
                dueDate: taskData.dueDate || null,
                priority: taskData.priority || 'medium',
                status: 'pending',
                repeat: taskData.repeat || 'none',
                reminders: taskData.reminder ? [taskData.reminder] : [],
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };

            appData.tasks.push(task);
            saveData();
            renderTasks();
            updateAnalytics();
            showNotification('تسک جدید با موفقیت اضافه شد', 'success');

            // Set reminder if specified
            if (task.reminders.length > 0) {
                setTaskReminder(task);
            }

            return task;
        }

        function updateTask(taskId, updates) {
            const taskIndex = appData.tasks.findIndex(task => task.id === taskId);
            if (taskIndex !== -1) {
                appData.tasks[taskIndex] = {
                    ...appData.tasks[taskIndex],
                    ...updates,
                    updatedAt: new Date().toISOString()
                };
                saveData();
                renderTasks();
                updateAnalytics();
            }
        }

        function deleteTask(taskId) {
            const taskIndex = appData.tasks.findIndex(task => task.id === taskId);
            if (taskIndex !== -1) {
                appData.tasks.splice(taskIndex, 1);
                saveData();
                renderTasks();
                updateAnalytics();
                showNotification('تسک حذف شد', 'success');
            }
        }

        function toggleTaskStatus(taskId) {
            const task = appData.tasks.find(task => task.id === taskId);
            if (task) {
                const newStatus = task.status === 'pending' ? 'done' : 'pending';
                updateTask(taskId, { status: newStatus });
                
                if (newStatus === 'done') {
                    showNotification('تسک تکمیل شد!', 'success');
                    
                    // Handle repeating tasks
                    if (task.repeat !== 'none') {
                        createRepeatingTask(task);
                    }
                }
            }
        }

        function createRepeatingTask(originalTask) {
            const newDueDate = calculateNextDueDate(originalTask.dueDate, originalTask.repeat);
            if (newDueDate) {
                const newTask = {
                    ...originalTask,
                    id: generateId(),
                    status: 'pending',
                    dueDate: newDueDate,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                appData.tasks.push(newTask);
                saveData();
                renderTasks();
                updateAnalytics();
                showNotification('تسک تکرارشونده جدید ایجاد شد', 'info');
            }
        }

        function calculateNextDueDate(currentDueDate, repeat) {
            if (!currentDueDate || repeat === 'none') return null;
            
            const date = new Date(currentDueDate);
            
            switch (repeat) {
                case 'daily':
                    date.setDate(date.getDate() + 1);
                    break;
                case 'weekly':
                    date.setDate(date.getDate() + 7);
                    break;
                case 'monthly':
                    date.setMonth(date.getMonth() + 1);
                    break;
                default:
                    return null;
            }
            
            return date.toISOString().slice(0, 16);
        }

        function setTaskReminder(task) {
            if (!task.reminders.length) return;
            
            task.reminders.forEach(reminderTime => {
                const reminderDate = new Date(reminderTime);
                const now = new Date();
                const timeUntilReminder = reminderDate.getTime() - now.getTime();
                
                if (timeUntilReminder > 0) {
                    setTimeout(() => {
                        showBrowserNotification(
                            'یادآوری تسک',
                            `زمان انجام تسک "${task.title}" فرا رسیده است.`
                        );
                        showNotification(`یادآوری: ${task.title}`, 'warning');
                    }, timeUntilReminder);
                }
            });
        }

        // Rendering Functions
        function renderTasks() {
            const filteredTasks = getFilteredTasks();
            const sortedTasks = getSortedTasks(filteredTasks);
            
            tasksList.innerHTML = '';
            
            if (sortedTasks.length === 0) {
                tasksList.innerHTML = `
                    <div class="text-center py-12">
                        <i class="fas fa-tasks text-gray-400 text-6xl mb-4"></i>
                        <p class="text-gray-500 dark:text-gray-400 text-lg">هیچ تسکی یافت نشد</p>
                    </div>
                `;
                return;
            }
            
            sortedTasks.forEach(task => {
                const taskElement = createTaskElement(task);
                tasksList.appendChild(taskElement);
            });
            
            // Initialize drag and drop
            new Sortable(tasksList, {
                animation: 150,
                ghostClass: 'sortable-ghost',
                onEnd: function(evt) {
                    // Update task order in data
                    const movedTask = appData.tasks.splice(evt.oldIndex, 1)[0];
                    appData.tasks.splice(evt.newIndex, 0, movedTask);
                    saveData();
                }
            });
        }

        function createTaskElement(task) {
            const div = document.createElement('div');
            div.className = `task-item bg-white dark:bg-dark-card rounded-lg shadow-md p-4 border dark:border-gray-700 priority-${task.priority} fade-in ${task.status === 'done' ? 'task-completed' : ''}`;
            div.setAttribute('data-task-id', task.id);
            
            const isOverdue = isPastDue(task.dueDate) && task.status === 'pending';
            const dueDateClass = isOverdue ? 'text-red-500' : 'text-gray-500 dark:text-gray-400';
            
            div.innerHTML = `
                <div class="flex items-start justify-between">
                    <div class="flex items-start space-x-3 space-x-reverse flex-1">
                        <button onclick="toggleTaskStatus('${task.id}')" 
                                class="mt-1 w-5 h-5 rounded border-2 border-gray-300 dark:border-gray-600 flex items-center justify-center hover:border-primary transition-colors ${task.status === 'done' ? 'bg-primary border-primary' : ''}">
                            ${task.status === 'done' ? '<i class="fas fa-check text-white text-xs"></i>' : ''}
                        </button>
                        <div class="flex-1">
                            <h3 class="font-semibold text-gray-900 dark:text-white ${task.status === 'done' ? 'line-through' : ''}">${task.title}</h3>
                            ${task.description ? `<p class="text-sm text-gray-600 dark:text-gray-400 mt-1">${task.description}</p>` : ''}
                            <div class="flex items-center space-x-4 space-x-reverse mt-2 text-xs">
                                ${task.dueDate ? `<span class="${dueDateClass}"><i class="fas fa-clock ml-1"></i>${formatDate(task.dueDate)}</span>` : ''}
                                ${task.repeat !== 'none' ? `<span class="text-blue-500"><i class="fas fa-redo ml-1"></i>${getRepeatText(task.repeat)}</span>` : ''}
                                <span class="px-2 py-1 rounded-full text-xs ${getPriorityClass(task.priority)}">${getPriorityText(task.priority)}</span>
                                ${isOverdue ? '<span class="text-red-500 font-medium">عقب‌افتاده</span>' : ''}
                            </div>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2 space-x-reverse">
                        <button onclick="editTask('${task.id}')" class="p-2 text-gray-400 hover:text-primary transition-colors">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="confirmDeleteTask('${task.id}')" class="p-2 text-gray-400 hover:text-red-500 transition-colors">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
            
            return div;
        }

        function renderTodayTasks() {
            const todayTasksList = appData.tasks.filter(task => isToday(task.dueDate));
            
            todayTasks.innerHTML = '';
            
            if (todayTasksList.length === 0) {
                todayTasks.innerHTML = `
                    <div class="text-center py-12">
                        <i class="fas fa-calendar-check text-gray-400 text-6xl mb-4"></i>
                        <p class="text-gray-500 dark:text-gray-400 text-lg">هیچ تسکی برای امروز تعریف نشده</p>
                    </div>
                `;
                return;
            }
            
            todayTasksList.forEach(task => {
                const taskElement = createTaskElement(task);
                todayTasks.appendChild(taskElement);
            });
        }

        function updateAnalytics() {
            const total = appData.tasks.length;
            const completed = appData.tasks.filter(task => task.status === 'done').length;
            const pending = appData.tasks.filter(task => task.status === 'pending').length;
            
            document.getElementById('totalTasks').textContent = total;
            document.getElementById('completedTasks').textContent = completed;
            document.getElementById('pendingTasks').textContent = pending;
        }

        // Helper Functions
        function getFilteredTasks() {
            let filtered = appData.tasks;
            
            if (statusFilter.value !== 'all') {
                filtered = filtered.filter(task => task.status === statusFilter.value);
            }
            
            if (priorityFilter.value !== 'all') {
                filtered = filtered.filter(task => task.priority === priorityFilter.value);
            }
            
            return filtered;
        }

        function getSortedTasks(tasks) {
            const sortCriteria = sortBy.value;
            
            return [...tasks].sort((a, b) => {
                switch (sortCriteria) {
                    case 'priority':
                        const priorityOrder = { high: 3, medium: 2, low: 1 };
                        return priorityOrder[b.priority] - priorityOrder[a.priority];
                    case 'dueDate':
                        if (!a.dueDate && !b.dueDate) return 0;
                        if (!a.dueDate) return 1;
                        if (!b.dueDate) return -1;
                        return new Date(a.dueDate) - new Date(b.dueDate);
                    case 'createdAt':
                        return new Date(b.createdAt) - new Date(a.createdAt);
                    default:
                        return 0;
                }
            });
        }

        function getPriorityClass(priority) {
            const classes = {
                high: 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200',
                medium: 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200',
                low: 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200'
            };
            return classes[priority] || classes.medium;
        }

        function getPriorityText(priority) {
            const texts = {
                high: 'بالا',
                medium: 'متوسط',
                low: 'پایین'
            };
            return texts[priority] || texts.medium;
        }

        function getRepeatText(repeat) {
            const texts = {
                daily: 'روزانه',
                weekly: 'هفتگی',
                monthly: 'ماهانه'
            };
            return texts[repeat] || '';
        }

        // Event Handlers
        async function confirmDeleteTask(taskId) {
            const confirmed = await showConfirmDialog('حذف تسک', 'آیا مطمئن هستید که می‌خواهید این تسک را حذف کنید؟');
            if (confirmed) {
                deleteTask(taskId);
            }
        }

        function editTask(taskId) {
            const task = appData.tasks.find(t => t.id === taskId);
            if (task) {
                // Fill form with task data
                document.getElementById('taskTitle').value = task.title;
                document.getElementById('taskDescription').value = task.description;
                document.getElementById('taskPriority').value = task.priority;
                document.getElementById('taskDueDate').value = task.dueDate ? task.dueDate.slice(0, 16) : '';
                document.getElementById('taskRepeat').value = task.repeat;
                document.getElementById('taskReminder').value = task.reminders[0] ? task.reminders[0].slice(0, 16) : '';
                
                // Change form to edit mode
                taskForm.setAttribute('data-editing', taskId);
                document.querySelector('#taskForm button[type="submit"]').innerHTML = '<i class="fas fa-save ml-2"></i>ذخیره تغییرات';
                
                // Scroll to form
                taskForm.scrollIntoView({ behavior: 'smooth' });
            }
        }

        // Event Listeners
        taskForm.addEventListener('submit', (e) => {
            e.preventDefault();
            
            const title = document.getElementById('taskTitle').value.trim();
            if (!title) {
                showNotification('لطفاً عنوان تسک را وارد کنید', 'error');
                return;
            }
            
            const taskData = {
                title: title,
                description: document.getElementById('taskDescription').value.trim(),
                priority: document.getElementById('taskPriority').value,
                dueDate: document.getElementById('taskDueDate').value,
                repeat: document.getElementById('taskRepeat').value,
                reminder: document.getElementById('taskReminder').value
            };
            
            const editingId = taskForm.getAttribute('data-editing');
            
            if (editingId) {
                // Update existing task
                updateTask(editingId, taskData);
                taskForm.removeAttribute('data-editing');
                document.querySelector('#taskForm button[type="submit"]').innerHTML = '<i class="fas fa-plus ml-2"></i>افزودن تسک';
                showNotification('تسک با موفقیت به‌روزرسانی شد', 'success');
            } else {
                // Add new task
                addTask(taskData);
            }
            
            taskForm.reset();
        });

        // Tab switching
        tabBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                const targetTab = btn.getAttribute('data-tab');
                
                // Update tab buttons
                tabBtns.forEach(b => {
                    b.classList.remove('tab-active');
                    b.classList.add('text-gray-600', 'dark:text-gray-400', 'hover:text-gray-900', 'dark:hover:text-white');
                });
                btn.classList.add('tab-active');
                btn.classList.remove('text-gray-600', 'dark:text-gray-400', 'hover:text-gray-900', 'dark:hover:text-white');
                
                // Update tab content
                tabContents.forEach(content => {
                    content.classList.add('hidden');
                });
                document.getElementById(targetTab + 'Tab').classList.remove('hidden');
                
                // Update content based on active tab
                if (targetTab === 'today') {
                    renderTodayTasks();
                } else if (targetTab === 'analytics') {
                    updateAnalytics();
                }
            });
        });

        // Filter and sort event listeners
        statusFilter.addEventListener('change', renderTasks);
        priorityFilter.addEventListener('change', renderTasks);
        sortBy.addEventListener('change', renderTasks);

        // Theme toggle
        themeToggle.addEventListener('click', toggleTheme);

        // Notification toggle
        notificationToggle.addEventListener('click', async () => {
            if (appData.settings.notificationsEnabled) {
                appData.settings.notificationsEnabled = false;
                showNotification('نوتیفیکیشن‌ها غیرفعال شد', 'info');
            } else {
                const granted = await requestNotificationPermission();
                if (granted) {
                    appData.settings.notificationsEnabled = true;
                    showNotification('نوتیفیکیشن‌ها فعال شد', 'success');
                } else {
                    showNotification('دسترسی به نوتیفیکیشن رد شد', 'error');
                }
            }
            saveData();
        });

        // Settings
        document.getElementById('notificationSetting').addEventListener('change', (e) => {
            appData.settings.notificationsEnabled = e.target.checked;
            saveData();
        });

        document.getElementById('clearAllData').addEventListener('click', async () => {
            const confirmed = await showConfirmDialog('پاک کردن همه داده‌ها', 'آیا مطمئن هستید؟ این عمل قابل بازگشت نیست.');
            if (confirmed) {
                appData.tasks = [];
                saveData();
                renderTasks();
                updateAnalytics();
                showNotification('تمام داده‌ها پاک شد', 'success');
            }
        });

        // Initialize App
        function initApp() {
            loadData();
            initTheme();
            renderTasks();
            updateAnalytics();
            
            // Set up notification setting
            document.getElementById('notificationSetting').checked = appData.settings.notificationsEnabled;
            
            // Set up existing task reminders
            appData.tasks.forEach(task => {
                if (task.reminders.length > 0) {
                    setTaskReminder(task);
                }
            });
            
            // Request notification permission if not already requested
            if (appData.settings.notificationsEnabled) {
                requestNotificationPermission();
            }
        }

        // Start the app
        initApp();
    </script>
</body>
</html>
